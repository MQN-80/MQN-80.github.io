<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mqn-80.github.io/posts/go/mem.html"><meta property="og:site_name" content="æ¢¦ç§‹å¹´"><meta property="og:title" content="Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°"><meta property="og:description" content="Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç° æ¦‚è¿° åœ¨å†¯Â·è¯ºä¼Šæ›¼çš„è®¾è®¡ç†å¿µçš„æŒ‡å¯¼ä¸‹ï¼Œè®¡ç®—æœºå°†è®¡ç®—ä¸å­˜å‚¨è¿™ä¸ªä¸¤å¤§æ ¸å¿ƒæ¨¡å—è¿›è¡Œåˆ†ç¦»ï¼ŒäºŒè€…é€šè¿‡æ€»çº¿è¿æ¥ï¼Œåè°ƒå·¥ä½œï¼š å¯¹äºè®¡ç®—è€Œè¨€ï¼ŒCPU æ— ç–‘æ˜¯æ ¸å¿ƒï¼ˆCPU å†…éƒ¨ç»“æ„æ— éœ€è¿‡å¤šå…³æ³¨ï¼‰ï¼Œä½†å¯¹äºå­˜å‚¨è€Œè¨€ï¼Œåˆ™è¦éº»çƒ¦çš„å¤šã€‚"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-07-04T02:52:32.000Z"><meta property="article:author" content="MQN-80"><meta property="article:tag" content="go"><meta property="article:tag" content="memory"><meta property="article:published_time" content="2022-06-23T00:00:00.000Z"><meta property="article:modified_time" content="2024-07-04T02:52:32.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°","image":[""],"datePublished":"2022-06-23T00:00:00.000Z","dateModified":"2024-07-04T02:52:32.000Z","author":[{"@type":"Person","name":"MQN-80","url":"https://github.com/MQN-80"}]}</script><title>Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç° | æ¢¦ç§‹å¹´</title><meta name="description" content="Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç° æ¦‚è¿° åœ¨å†¯Â·è¯ºä¼Šæ›¼çš„è®¾è®¡ç†å¿µçš„æŒ‡å¯¼ä¸‹ï¼Œè®¡ç®—æœºå°†è®¡ç®—ä¸å­˜å‚¨è¿™ä¸ªä¸¤å¤§æ ¸å¿ƒæ¨¡å—è¿›è¡Œåˆ†ç¦»ï¼ŒäºŒè€…é€šè¿‡æ€»çº¿è¿æ¥ï¼Œåè°ƒå·¥ä½œï¼š å¯¹äºè®¡ç®—è€Œè¨€ï¼ŒCPU æ— ç–‘æ˜¯æ ¸å¿ƒï¼ˆCPU å†…éƒ¨ç»“æ„æ— éœ€è¿‡å¤šå…³æ³¨ï¼‰ï¼Œä½†å¯¹äºå­˜å‚¨è€Œè¨€ï¼Œåˆ™è¦éº»çƒ¦çš„å¤šã€‚">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-52db350f.css" as="style"><link rel="stylesheet" href="/assets/style-52db350f.css">
    <link rel="modulepreload" href="/assets/app-7dd07e0d.js"><link rel="modulepreload" href="/assets/mem.html-cb9b8964.js"><link rel="modulepreload" href="/assets/mem.html-ed13f8fb.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-612d6d05.js" as="script"><link rel="prefetch" href="/assets/home.html-2a6b0012.js" as="script"><link rel="prefetch" href="/assets/slide.html-8852c9fa.js" as="script"><link rel="prefetch" href="/assets/crdt1.html-8c60ed08.js" as="script"><link rel="prefetch" href="/assets/crdt2.html-332011a1.js" as="script"><link rel="prefetch" href="/assets/crdt3.html-25583a16.js" as="script"><link rel="prefetch" href="/assets/sheet.html-d13b8a87.js" as="script"><link rel="prefetch" href="/assets/lsm-tree.html-cf1ed8fb.js" as="script"><link rel="prefetch" href="/assets/neural.html-d150a756.js" as="script"><link rel="prefetch" href="/assets/cmu15445-1.html-850af661.js" as="script"><link rel="prefetch" href="/assets/cmu15445-2.html-b2f8190d.js" as="script"><link rel="prefetch" href="/assets/cmu15445-3.html-51ef8598.js" as="script"><link rel="prefetch" href="/assets/cmu15445-4.html-1a11931b.js" as="script"><link rel="prefetch" href="/assets/cmu15445-5.html-dbe88350.js" as="script"><link rel="prefetch" href="/assets/cmu15445-6.html-0ba88a32.js" as="script"><link rel="prefetch" href="/assets/diskqueue.html-063114bd.js" as="script"><link rel="prefetch" href="/assets/distributedkv.html-9e147ab4.js" as="script"><link rel="prefetch" href="/assets/raft.html-9cb1a382.js" as="script"><link rel="prefetch" href="/assets/rpc.html-8428392c.js" as="script"><link rel="prefetch" href="/assets/tinymq.html-f82b8345.js" as="script"><link rel="prefetch" href="/assets/guiding.html-19d3764c.js" as="script"><link rel="prefetch" href="/assets/tdd1.html-569963e7.js" as="script"><link rel="prefetch" href="/assets/tinybatis.html-6c497309.js" as="script"><link rel="prefetch" href="/assets/generics.html-82209f34.js" as="script"><link rel="prefetch" href="/assets/helloworld.html-16c99634.js" as="script"><link rel="prefetch" href="/assets/magic.html-0b33d700.js" as="script"><link rel="prefetch" href="/assets/magic2.html-e67bb315.js" as="script"><link rel="prefetch" href="/assets/magic3.html-ef28c33e.js" as="script"><link rel="prefetch" href="/assets/plan9.html-49852f8f.js" as="script"><link rel="prefetch" href="/assets/pool.html-66c18d8b.js" as="script"><link rel="prefetch" href="/assets/talk.html-03651520.js" as="script"><link rel="prefetch" href="/assets/tcp-impl.html-54673ff2.js" as="script"><link rel="prefetch" href="/assets/buffer.html-4ed334c8.js" as="script"><link rel="prefetch" href="/assets/outpoint.html-8dfecc79.js" as="script"><link rel="prefetch" href="/assets/linux-patch.html-c3878778.js" as="script"><link rel="prefetch" href="/assets/404.html-13563100.js" as="script"><link rel="prefetch" href="/assets/index.html-53325beb.js" as="script"><link rel="prefetch" href="/assets/index.html-6ebffa82.js" as="script"><link rel="prefetch" href="/assets/index.html-198ea373.js" as="script"><link rel="prefetch" href="/assets/index.html-32c4c9be.js" as="script"><link rel="prefetch" href="/assets/index.html-30619fe2.js" as="script"><link rel="prefetch" href="/assets/index.html-bd628589.js" as="script"><link rel="prefetch" href="/assets/index.html-e1617982.js" as="script"><link rel="prefetch" href="/assets/index.html-4a15a158.js" as="script"><link rel="prefetch" href="/assets/index.html-d54a1ecb.js" as="script"><link rel="prefetch" href="/assets/index.html-66659335.js" as="script"><link rel="prefetch" href="/assets/index.html-24527d98.js" as="script"><link rel="prefetch" href="/assets/index.html-9b3139fa.js" as="script"><link rel="prefetch" href="/assets/index.html-5975ed8e.js" as="script"><link rel="prefetch" href="/assets/index.html-4faf3988.js" as="script"><link rel="prefetch" href="/assets/index.html-65ca019a.js" as="script"><link rel="prefetch" href="/assets/index.html-44d6360f.js" as="script"><link rel="prefetch" href="/assets/index.html-a3b3d27d.js" as="script"><link rel="prefetch" href="/assets/index.html-69ca8333.js" as="script"><link rel="prefetch" href="/assets/index.html-cf31fcb4.js" as="script"><link rel="prefetch" href="/assets/index.html-151f4cec.js" as="script"><link rel="prefetch" href="/assets/index.html-bbc22d5d.js" as="script"><link rel="prefetch" href="/assets/index.html-8e3dfb8b.js" as="script"><link rel="prefetch" href="/assets/index.html-91b0fdc5.js" as="script"><link rel="prefetch" href="/assets/index.html-6a2bbe8e.js" as="script"><link rel="prefetch" href="/assets/index.html-4ae0e789.js" as="script"><link rel="prefetch" href="/assets/index.html-12451514.js" as="script"><link rel="prefetch" href="/assets/index.html-e17c2f99.js" as="script"><link rel="prefetch" href="/assets/index.html-7ee77a34.js" as="script"><link rel="prefetch" href="/assets/index.html-d6d1d51e.js" as="script"><link rel="prefetch" href="/assets/index.html-4ed8aea9.js" as="script"><link rel="prefetch" href="/assets/index.html-6842990e.js" as="script"><link rel="prefetch" href="/assets/index.html-22cea12f.js" as="script"><link rel="prefetch" href="/assets/index.html-ec3225a4.js" as="script"><link rel="prefetch" href="/assets/index.html-4d54f03e.js" as="script"><link rel="prefetch" href="/assets/index.html-253af189.js" as="script"><link rel="prefetch" href="/assets/index.html-29eddfb0.js" as="script"><link rel="prefetch" href="/assets/index.html-adc7ae1c.js" as="script"><link rel="prefetch" href="/assets/index.html-71da4c80.js" as="script"><link rel="prefetch" href="/assets/index.html-df715249.js" as="script"><link rel="prefetch" href="/assets/index.html-007d8304.js" as="script"><link rel="prefetch" href="/assets/index.html-0d1c0ea4.js" as="script"><link rel="prefetch" href="/assets/index.html-70b5e85e.js" as="script"><link rel="prefetch" href="/assets/index.html-8e4b6935.js" as="script"><link rel="prefetch" href="/assets/index.html-aff9ce46.js" as="script"><link rel="prefetch" href="/assets/index.html-f4629810.js" as="script"><link rel="prefetch" href="/assets/index.html-21fba2c0.js" as="script"><link rel="prefetch" href="/assets/index.html-5f916b62.js" as="script"><link rel="prefetch" href="/assets/index.html-ac9356aa.js" as="script"><link rel="prefetch" href="/assets/index.html-f6157cf0.js" as="script"><link rel="prefetch" href="/assets/index.html-997de5d0.js" as="script"><link rel="prefetch" href="/assets/index.html-17daa3d3.js" as="script"><link rel="prefetch" href="/assets/index.html-096e6a14.js" as="script"><link rel="prefetch" href="/assets/index.html-2394dd5f.js" as="script"><link rel="prefetch" href="/assets/index.html-317bdbaf.js" as="script"><link rel="prefetch" href="/assets/index.html-23b8401c.js" as="script"><link rel="prefetch" href="/assets/index.html-d382eda5.js" as="script"><link rel="prefetch" href="/assets/index.html-bb2a076e.js" as="script"><link rel="prefetch" href="/assets/index.html-fc2896d1.js" as="script"><link rel="prefetch" href="/assets/index.html-6a28d83e.js" as="script"><link rel="prefetch" href="/assets/index.html-41ad0b6a.js" as="script"><link rel="prefetch" href="/assets/index.html-619b05ff.js" as="script"><link rel="prefetch" href="/assets/index.html-cfdb52e9.js" as="script"><link rel="prefetch" href="/assets/index.html-c6bdda76.js" as="script"><link rel="prefetch" href="/assets/index.html-28cb6d18.js" as="script"><link rel="prefetch" href="/assets/index.html-bb5eb25d.js" as="script"><link rel="prefetch" href="/assets/index.html-60e71856.js" as="script"><link rel="prefetch" href="/assets/home.html-76c71c23.js" as="script"><link rel="prefetch" href="/assets/slide.html-41652f6c.js" as="script"><link rel="prefetch" href="/assets/crdt1.html-334f4cdc.js" as="script"><link rel="prefetch" href="/assets/crdt2.html-9412c40c.js" as="script"><link rel="prefetch" href="/assets/crdt3.html-62ac0d92.js" as="script"><link rel="prefetch" href="/assets/sheet.html-57409ac1.js" as="script"><link rel="prefetch" href="/assets/lsm-tree.html-7fcdb556.js" as="script"><link rel="prefetch" href="/assets/neural.html-af1ac485.js" as="script"><link rel="prefetch" href="/assets/cmu15445-1.html-4e338d1e.js" as="script"><link rel="prefetch" href="/assets/cmu15445-2.html-0e261f3b.js" as="script"><link rel="prefetch" href="/assets/cmu15445-3.html-46c5f2d1.js" as="script"><link rel="prefetch" href="/assets/cmu15445-4.html-4d89260e.js" as="script"><link rel="prefetch" href="/assets/cmu15445-5.html-aec17bd7.js" as="script"><link rel="prefetch" href="/assets/cmu15445-6.html-13915745.js" as="script"><link rel="prefetch" href="/assets/diskqueue.html-720a5093.js" as="script"><link rel="prefetch" href="/assets/distributedkv.html-965810f7.js" as="script"><link rel="prefetch" href="/assets/raft.html-04abe3fa.js" as="script"><link rel="prefetch" href="/assets/rpc.html-0257d86b.js" as="script"><link rel="prefetch" href="/assets/tinymq.html-a5a63c55.js" as="script"><link rel="prefetch" href="/assets/guiding.html-a4f17c43.js" as="script"><link rel="prefetch" href="/assets/tdd1.html-43fff4df.js" as="script"><link rel="prefetch" href="/assets/tinybatis.html-8778b969.js" as="script"><link rel="prefetch" href="/assets/generics.html-10406d94.js" as="script"><link rel="prefetch" href="/assets/helloworld.html-bc1f315e.js" as="script"><link rel="prefetch" href="/assets/magic.html-d1f3fe57.js" as="script"><link rel="prefetch" href="/assets/magic2.html-256391af.js" as="script"><link rel="prefetch" href="/assets/magic3.html-b1586ceb.js" as="script"><link rel="prefetch" href="/assets/plan9.html-c673bac0.js" as="script"><link rel="prefetch" href="/assets/pool.html-7b22194f.js" as="script"><link rel="prefetch" href="/assets/talk.html-d3511788.js" as="script"><link rel="prefetch" href="/assets/tcp-impl.html-58e232fb.js" as="script"><link rel="prefetch" href="/assets/buffer.html-831a4fbc.js" as="script"><link rel="prefetch" href="/assets/outpoint.html-01ffa95d.js" as="script"><link rel="prefetch" href="/assets/linux-patch.html-064675c6.js" as="script"><link rel="prefetch" href="/assets/404.html-cfc0b76b.js" as="script"><link rel="prefetch" href="/assets/index.html-e8823ebc.js" as="script"><link rel="prefetch" href="/assets/index.html-d72bef88.js" as="script"><link rel="prefetch" href="/assets/index.html-4814e1fc.js" as="script"><link rel="prefetch" href="/assets/index.html-c12ec9a8.js" as="script"><link rel="prefetch" href="/assets/index.html-15fdb95e.js" as="script"><link rel="prefetch" href="/assets/index.html-2b85a23d.js" as="script"><link rel="prefetch" href="/assets/index.html-82aac262.js" as="script"><link rel="prefetch" href="/assets/index.html-94a66ce6.js" as="script"><link rel="prefetch" href="/assets/index.html-b05598f9.js" as="script"><link rel="prefetch" href="/assets/index.html-da717422.js" as="script"><link rel="prefetch" href="/assets/index.html-e17f13d4.js" as="script"><link rel="prefetch" href="/assets/index.html-b723c09b.js" as="script"><link rel="prefetch" href="/assets/index.html-1e66bfaa.js" as="script"><link rel="prefetch" href="/assets/index.html-096128c8.js" as="script"><link rel="prefetch" href="/assets/index.html-d8548402.js" as="script"><link rel="prefetch" href="/assets/index.html-1d642ecd.js" as="script"><link rel="prefetch" href="/assets/index.html-31b8665f.js" as="script"><link rel="prefetch" href="/assets/index.html-60193719.js" as="script"><link rel="prefetch" href="/assets/index.html-33a3c455.js" as="script"><link rel="prefetch" href="/assets/index.html-ad235cb7.js" as="script"><link rel="prefetch" href="/assets/index.html-024fb5be.js" as="script"><link rel="prefetch" href="/assets/index.html-c1c26240.js" as="script"><link rel="prefetch" href="/assets/index.html-4e4b8fe1.js" as="script"><link rel="prefetch" href="/assets/index.html-33799dc0.js" as="script"><link rel="prefetch" href="/assets/index.html-8f765477.js" as="script"><link rel="prefetch" href="/assets/index.html-0bba4dd5.js" as="script"><link rel="prefetch" href="/assets/index.html-a5b96f46.js" as="script"><link rel="prefetch" href="/assets/index.html-c24026dc.js" as="script"><link rel="prefetch" href="/assets/index.html-cdaa6d66.js" as="script"><link rel="prefetch" href="/assets/index.html-d09d492f.js" as="script"><link rel="prefetch" href="/assets/index.html-7680372e.js" as="script"><link rel="prefetch" href="/assets/index.html-243df84d.js" as="script"><link rel="prefetch" href="/assets/index.html-bc202dd7.js" as="script"><link rel="prefetch" href="/assets/index.html-ce6c0321.js" as="script"><link rel="prefetch" href="/assets/index.html-9e59d5f6.js" as="script"><link rel="prefetch" href="/assets/index.html-1fff8709.js" as="script"><link rel="prefetch" href="/assets/index.html-b4f3e9b3.js" as="script"><link rel="prefetch" href="/assets/index.html-6a67c476.js" as="script"><link rel="prefetch" href="/assets/index.html-25b4d52a.js" as="script"><link rel="prefetch" href="/assets/index.html-a9d9bbf4.js" as="script"><link rel="prefetch" href="/assets/index.html-1a87a757.js" as="script"><link rel="prefetch" href="/assets/index.html-b69a25fc.js" as="script"><link rel="prefetch" href="/assets/index.html-0288697d.js" as="script"><link rel="prefetch" href="/assets/index.html-9318b211.js" as="script"><link rel="prefetch" href="/assets/index.html-a8e48898.js" as="script"><link rel="prefetch" href="/assets/index.html-980b09c9.js" as="script"><link rel="prefetch" href="/assets/index.html-1be4428d.js" as="script"><link rel="prefetch" href="/assets/index.html-a6166801.js" as="script"><link rel="prefetch" href="/assets/index.html-d812da1e.js" as="script"><link rel="prefetch" href="/assets/index.html-26e9e6a9.js" as="script"><link rel="prefetch" href="/assets/index.html-565f9b15.js" as="script"><link rel="prefetch" href="/assets/index.html-9bdb8e93.js" as="script"><link rel="prefetch" href="/assets/index.html-90fbb748.js" as="script"><link rel="prefetch" href="/assets/index.html-6e895996.js" as="script"><link rel="prefetch" href="/assets/index.html-6d3c3e63.js" as="script"><link rel="prefetch" href="/assets/index.html-3eff3cb9.js" as="script"><link rel="prefetch" href="/assets/index.html-9ac78e5e.js" as="script"><link rel="prefetch" href="/assets/index.html-369f233d.js" as="script"><link rel="prefetch" href="/assets/index.html-54e4b039.js" as="script"><link rel="prefetch" href="/assets/index.html-d23dcc8e.js" as="script"><link rel="prefetch" href="/assets/index.html-3dd90498.js" as="script"><link rel="prefetch" href="/assets/index.html-ddd014e5.js" as="script"><link rel="prefetch" href="/assets/index.html-7b160231.js" as="script"><link rel="prefetch" href="/assets/index.html-a67bbe2b.js" as="script"><link rel="prefetch" href="/assets/index.html-f8970cd0.js" as="script"><link rel="prefetch" href="/assets/giscus-8d5a43f1.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-a723b805.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-9d5bc2ce.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-1a4c3ae7.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-3ee328cd.js" as="script"><link rel="prefetch" href="/assets/SearchResult-e8b7efa1.js" as="script"><link rel="prefetch" href="/assets/Chat-4971c349.js" as="script"><link rel="prefetch" href="/assets/CounterDemo1-10cc8c26.js" as="script"><link rel="prefetch" href="/assets/Demo-e0b7248f.js" as="script"><link rel="prefetch" href="/assets/MulRegisterDemo-59d9de37.js" as="script"><link rel="prefetch" href="/assets/RGADemo-c12c1372.js" as="script"><link rel="prefetch" href="/assets/RegisterDemo-ba2516af.js" as="script"><link rel="prefetch" href="/assets/YjsDemo-8a61345e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="/photo.jpg" alt="æ¢¦ç§‹å¹´"><!----><span class="vp-site-name hide-in-pad">æ¢¦ç§‹å¹´</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="æ¢¦ç§‹å¹´" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>æ¢¦ç§‹å¹´<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="å½’æ¡£"><span class="title"><span class="font-icon icon iconfont icon-edit" style=""></span>å½’æ¡£</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>go</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="ä» Hello World æ¥çœ‹çœ‹ go çš„è¿è¡Œæµç¨‹" class="vp-link nav-link nav-link" href="/posts/go/helloworld.html"><span class="font-icon icon iconfont icon-edit" style=""></span>ä» Hello World æ¥çœ‹çœ‹ go çš„è¿è¡Œæµç¨‹<!----></a></li><li class="dropdown-subitem"><a aria-label="go æ±‡ç¼–ç®€å•å…¥é—¨" class="vp-link nav-link nav-link" href="/posts/go/plan9.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go æ±‡ç¼–ç®€å•å…¥é—¨<!----></a></li><li class="dropdown-subitem"><a aria-label="go æ³›å‹å°é²œï¼Œå®ç°ä¸€ä¸ªæµå¼å¤„ç†åº“" class="vp-link nav-link nav-link" href="/posts/go/generics.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go æ³›å‹å°é²œï¼Œå®ç°ä¸€ä¸ªæµå¼å¤„ç†åº“<!----></a></li><li class="dropdown-subitem"><a aria-label="go pool æ± åŒ–å­¦ä¹ ã€å®è·µæ€»ç»“" class="vp-link nav-link nav-link" href="/posts/go/pool.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go pool æ± åŒ–å­¦ä¹ ã€å®è·µæ€»ç»“<!----></a></li><li class="dropdown-subitem"><a aria-label="go çš„ä¸¤ä¸ªé»‘é­”æ³•æŠ€å·§" class="vp-link nav-link nav-link" href="/posts/go/magic.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go çš„ä¸¤ä¸ªé»‘é­”æ³•æŠ€å·§<!----></a></li><li class="dropdown-subitem"><a aria-label="go å¦å¤–å‡ ä¸ªé»‘é­”æ³•æŠ€å·§" class="vp-link nav-link nav-link" href="/posts/go/magic2.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go å¦å¤–å‡ ä¸ªé»‘é­”æ³•æŠ€å·§<!----></a></li><li class="dropdown-subitem"><a aria-label="Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°" class="vp-link nav-link active nav-link active" href="/posts/go/mem.html"><span class="font-icon icon iconfont icon-edit" style=""></span>Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>network</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆç”¨æˆ·æ€ TCP åè®®å®ç°" class="vp-link nav-link nav-link" href="/posts/network/tcp-impl.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆç”¨æˆ·æ€ TCP åè®®å®ç°<!----></a></li><li class="dropdown-subitem"><a aria-label="Talk Room" class="vp-link nav-link nav-link" href="/posts/network/talk.html"><span class="font-icon icon iconfont icon-edit" style=""></span>Talk Room<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>os</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="å¸¦ä½ ä¿®æ”¹ä¸€æ¬¡ Linux å†…æ ¸" class="vp-link nav-link nav-link" href="/posts/os/linux-patch.html"><span class="font-icon icon iconfont icon-edit" style=""></span>å¸¦ä½ ä¿®æ”¹ä¸€æ¬¡ Linux å†…æ ¸<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>distribute</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆ Raft åˆ†å¸ƒå¼å…±è¯†æ€§ç®—æ³•çš„å®ç°" class="vp-link nav-link nav-link" href="/posts/distribute/raft.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆ Raft åˆ†å¸ƒå¼å…±è¯†æ€§ç®—æ³•çš„å®ç°<!----></a></li><li class="dropdown-subitem"><a aria-label="tinyrpc è®¾è®¡ä¸å®ç°" class="vp-link nav-link nav-link" href="/posts/distribute/rpc.html"><span class="font-icon icon iconfont icon-edit" style=""></span>tinyrpc è®¾è®¡ä¸å®ç°<!----></a></li><li class="dropdown-subitem"><a aria-label="diskqueueæŒä¹…åŒ–é˜Ÿåˆ—è®¾è®¡æ¼”è¿›" class="vp-link nav-link nav-link" href="/posts/distribute/diskqueue.html"><span class="font-icon icon iconfont icon-edit" style=""></span>diskqueueæŒä¹…åŒ–é˜Ÿåˆ—è®¾è®¡æ¼”è¿›<!----></a></li><li class="dropdown-subitem"><a aria-label="tinymqè®¾è®¡ä¸å®ç°" class="vp-link nav-link nav-link" href="/posts/distribute/tinymq.html"><span class="font-icon icon iconfont icon-edit" style=""></span>tinymqè®¾è®¡ä¸å®ç°<!----></a></li><li class="dropdown-subitem"><a aria-label="distributed-kv è®¾è®¡ä¸å®ç°" class="vp-link nav-link nav-link" href="/posts/distribute/distributedkv.html"><span class="font-icon icon iconfont icon-edit" style=""></span>distributed-kv è®¾è®¡ä¸å®ç°<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>engineering</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="TDDå­¦ä¹ å¿ƒå¾—" class="vp-link nav-link nav-link" href="/posts/engineering/tdd1.html"><span class="font-icon icon iconfont icon-edit" style=""></span>TDDå­¦ä¹ å¿ƒå¾—<!----></a></li><li class="dropdown-subitem"><a aria-label="TDDå®è·µâ€”â€”ä»é›¶å†™ä¸€ä¸ªç®€å•çš„Mybatisâ€”â€”TinyBatis" class="vp-link nav-link nav-link" href="/posts/engineering/tinybatis.html"><span class="font-icon icon iconfont icon-edit" style=""></span>TDDå®è·µâ€”â€”ä»é›¶å†™ä¸€ä¸ªç®€å•çš„Mybatisâ€”â€”TinyBatis<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>database</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(1)â€”â€”æ€»è§ˆ" class="vp-link nav-link nav-link" href="/posts/database/cmu15445-1.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(1)â€”â€”æ€»è§ˆ<!----></a></li><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(2)â€”â€”ç¼“å­˜æ± " class="vp-link nav-link nav-link" href="/posts/database/cmu15445-2.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(2)â€”â€”ç¼“å­˜æ± <!----></a></li><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(3)â€”â€”å¹¶å‘B+æ ‘" class="vp-link nav-link nav-link" href="/posts/database/cmu15445-3.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(3)â€”â€”å¹¶å‘B+æ ‘<!----></a></li><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(4)â€”â€”æ‰§è¡Œå™¨" class="vp-link nav-link nav-link" href="/posts/database/cmu15445-4.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(4)â€”â€”æ‰§è¡Œå™¨<!----></a></li><li class="dropdown-subitem"><a aria-label="è°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(5)â€”â€”å¹¶å‘æ§åˆ¶" class="vp-link nav-link nav-link" href="/posts/database/cmu15445-5.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(5)â€”â€”å¹¶å‘æ§åˆ¶<!----></a></li><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(6)â€”â€”æ—¥å¿—å’Œæ¢å¤" class="vp-link nav-link nav-link" href="/posts/database/cmu15445-6.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆå…³ç³»æ•°æ®åº“çš„è®¾è®¡ä¸å®ç°(6)â€”â€”æ—¥å¿—å’Œæ¢å¤<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>collaborate</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="è°ˆè°ˆåœ¨çº¿è¡¨æ ¼ååŒæ–¹æ¡ˆ" class="vp-link nav-link nav-link" href="/posts/co/sheet.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è°ˆè°ˆåœ¨çº¿è¡¨æ ¼ååŒæ–¹æ¡ˆ<!----></a></li><li class="dropdown-subitem"><a aria-label="æ·±å…¥ç†è§£CRDT-åŸºç¡€ç¯‡" class="vp-link nav-link nav-link" href="/posts/co/crdt1.html"><span class="font-icon icon iconfont icon-edit" style=""></span>æ·±å…¥ç†è§£CRDT-åŸºç¡€ç¯‡<!----></a></li><li class="dropdown-subitem"><a aria-label="æ·±å…¥ç†è§£CRDT-RGAç¯‡" class="vp-link nav-link nav-link" href="/posts/co/crdt2.html"><span class="font-icon icon iconfont icon-edit" style=""></span>æ·±å…¥ç†è§£CRDT-RGAç¯‡<!----></a></li><li class="dropdown-subitem"><a aria-label="æ·±å…¥ç†è§£CRDT-YATAç¯‡" class="vp-link nav-link nav-link" href="/posts/co/crdt3.html"><span class="font-icon icon iconfont icon-edit" style=""></span>æ·±å…¥ç†è§£CRDT-YATAç¯‡<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ai</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="è·Ÿç€ ChatGPT å­¦ LSM Tree" class="vp-link nav-link nav-link" href="/posts/ai/lsm-tree.html"><span class="font-icon icon iconfont icon-edit" style=""></span>è·Ÿç€ ChatGPT å­¦ LSM Tree<!----></a></li><li class="dropdown-subitem"><a aria-label="æ‰‹åŠ¨å®ç°åå‘ä¼ æ’­ç®—æ³•" class="vp-link nav-link nav-link" href="/posts/ai/neural.html"><span class="font-icon icon iconfont icon-edit" style=""></span>æ‰‹åŠ¨å®ç°åå‘ä¼ æ’­ç®—æ³•<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/MQN-80/MQN-80.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="æ¢¦ç§‹å¹´" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>æ¢¦ç§‹å¹´<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading active"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">æ–‡ç« </span><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">go</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a aria-label="ä» Hello World æ¥çœ‹çœ‹ go çš„è¿è¡Œæµç¨‹" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/go/helloworld.html"><span class="font-icon icon iconfont icon-edit" style=""></span>ä» Hello World æ¥çœ‹çœ‹ go çš„è¿è¡Œæµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="go æ±‡ç¼–ç®€å•å…¥é—¨" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/go/plan9.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go æ±‡ç¼–ç®€å•å…¥é—¨<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="go æ³›å‹å°é²œï¼Œå®ç°ä¸€ä¸ªæµå¼å¤„ç†åº“" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/go/generics.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go æ³›å‹å°é²œï¼Œå®ç°ä¸€ä¸ªæµå¼å¤„ç†åº“<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="go pool æ± åŒ–å­¦ä¹ ã€å®è·µæ€»ç»“" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/go/pool.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go pool æ± åŒ–å­¦ä¹ ã€å®è·µæ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="go çš„ä¸¤ä¸ªé»‘é­”æ³•æŠ€å·§" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/go/magic.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go çš„ä¸¤ä¸ªé»‘é­”æ³•æŠ€å·§<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="go å¦å¤–å‡ ä¸ªé»‘é­”æ³•æŠ€å·§" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/posts/go/magic2.html"><span class="font-icon icon iconfont icon-edit" style=""></span>go å¦å¤–å‡ ä¸ªé»‘é­”æ³•æŠ€å·§<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/posts/go/mem.html"><span class="font-icon icon iconfont icon-edit" style=""></span>Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="æ¦‚è¿°" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#æ¦‚è¿°"><!---->æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="å†…å­˜å¸ƒå±€" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#å†…å­˜å¸ƒå±€"><!---->å†…å­˜å¸ƒå±€<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ç®¡ç†æ–¹å¼" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#ç®¡ç†æ–¹å¼"><!---->ç®¡ç†æ–¹å¼<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="æ‰‹åŠ¨ç®¡ç†" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#æ‰‹åŠ¨ç®¡ç†"><!---->æ‰‹åŠ¨ç®¡ç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="è‡ªåŠ¨ç®¡ç†" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#è‡ªåŠ¨ç®¡ç†"><!---->è‡ªåŠ¨ç®¡ç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="å†…å­˜ç®¡ç†" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#å†…å­˜ç®¡ç†"><!---->å†…å­˜ç®¡ç†<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="å†…å­˜åˆ†é…åŸç†" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#å†…å­˜åˆ†é…åŸç†"><!---->å†…å­˜åˆ†é…åŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="GC å®è·µ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#gc-å®è·µ"><!---->GC å®è·µ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ"><!---->æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ"><!---->è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="Go å†…å­˜ç®¡ç†" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#go-å†…å­˜ç®¡ç†"><!---->Go å†…å­˜ç®¡ç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="æ€»ç»“" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#æ€»ç»“"><!---->æ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="å‚è€ƒèµ„æ–™" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/posts/go/mem.html#å‚è€ƒèµ„æ–™"><!---->å‚è€ƒèµ„æ–™<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">network</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">os</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">distribute</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">engineering</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">database</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">collaborate</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">ai</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon iconfont icon-note" style=""></span><span class="vp-sidebar-title">optimization</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon iconfont icon-edit" style=""></span>Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/MQN-80" target="_blank" rel="noopener noreferrer">MQN-80</a></span><span property="author" content="MQN-80"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-06-23T00:00:00.000Z"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category2 clickable" role="navigation">go</span><!--]--><meta property="articleSection" content="go"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag2 clickable" role="navigation">go</span><span class="page-tag-item tag6 clickable" role="navigation">memory</span><!--]--><meta property="keywords" content="go,memory"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 39 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT39M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#æ¦‚è¿°">æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#å†…å­˜å¸ƒå±€">å†…å­˜å¸ƒå±€</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#ç®¡ç†æ–¹å¼">ç®¡ç†æ–¹å¼</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#æ‰‹åŠ¨ç®¡ç†">æ‰‹åŠ¨ç®¡ç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#è‡ªåŠ¨ç®¡ç†">è‡ªåŠ¨ç®¡ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#å†…å­˜åˆ†é…åŸç†">å†…å­˜åˆ†é…åŸç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#gc-å®è·µ">GC å®è·µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ">æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="/#è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ">è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#go-å†…å­˜ç®¡ç†">Go å†…å­˜ç®¡ç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#æ€»ç»“">æ€»ç»“</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="go-å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°" tabindex="-1"><a class="header-anchor" href="#go-å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°" aria-hidden="true">#</a> Go å†…å­˜ç®¡ç†è®¾è®¡ä¸å®ç°</h1><h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h2><p>åœ¨<a href="https://zh.wikipedia.org/wiki/%E5%86%AF%C2%B7%E8%AF%BA%E4%BC%8A%E6%9B%BC%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">å†¯Â·è¯ºä¼Šæ›¼<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„è®¾è®¡ç†å¿µçš„æŒ‡å¯¼ä¸‹ï¼Œè®¡ç®—æœºå°†<strong>è®¡ç®—</strong>ä¸<strong>å­˜å‚¨</strong>è¿™ä¸ªä¸¤å¤§æ ¸å¿ƒæ¨¡å—è¿›è¡Œåˆ†ç¦»ï¼ŒäºŒè€…é€šè¿‡<strong>æ€»çº¿</strong>è¿æ¥ï¼Œåè°ƒå·¥ä½œï¼š</p><img alt="å†¯Â·è¯ºä¼Šæ›¼ç»“æ„" src="/assets/å†¯è¯ºä¾æ›¼ç»“æ„-81cdac1a.png" width="50%" height="50%" style="margin:0 auto;"><p>å¯¹äºè®¡ç®—è€Œè¨€ï¼ŒCPU æ— ç–‘æ˜¯æ ¸å¿ƒï¼ˆCPU å†…éƒ¨ç»“æ„æ— éœ€è¿‡å¤šå…³æ³¨ï¼‰ï¼Œä½†å¯¹äºå­˜å‚¨è€Œè¨€ï¼Œåˆ™è¦éº»çƒ¦çš„å¤šã€‚</p><p>å¸¦æ¥è¿™ä¸ªéº»çƒ¦çš„ä¸»è¦å› ç´ åœ¨äºï¼šCPU ä¸å­˜å‚¨è®¾å¤‡ä¹‹é—´å·¨å¤§çš„é€Ÿåº¦å·®å¼‚ã€‚</p><p>ä»¥ CPU çš„æŒ‡ä»¤å‘¨æœŸä¸ºå•ä½ï¼Œå¦‚æœæ•°æ®åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆ CPU è®¿é—®åˆ°æ•°æ®åªéœ€ 4 ï½ 75 ä¸ªå‘¨æœŸï¼Œå¦‚æœåœ¨å†…å­˜ä¸­ï¼Œåˆ™éœ€è¦ä¸Šç™¾ä¸ªå‘¨æœŸï¼Œè€Œå¦‚æœåœ¨ç£ç›˜ä¸­ï¼Œé‚£ä¹ˆå°±éœ€è¦å‡ åƒä¸‡ä¸ªå‘¨æœŸã€‚</p><p>å­˜å‚¨è®¾å¤‡ç±»å‹çš„ä¸åŒä¹Ÿä¼šå¸¦æ¥å­˜å‚¨æ€§èƒ½å·¨å¤§çš„å·®å¼‚ï¼Œæ¯”å¦‚ SRAMï¼ˆStatic Random-Access Memoryï¼‰å­˜å‚¨è®¾å¤‡æ€§èƒ½å¾ˆé«˜ï¼Œè¢«ç”¨æ¥ä½œä¸º CPU çš„é«˜é€Ÿç¼“å­˜ï¼ŒCPU è®¿é—®å®ƒä»¬åªéœ€å‡ ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè€Œ DRAMï¼ˆDynamic Random-Access Memoryï¼‰è¢«ç”¨åšä¸»å­˜ï¼ˆå†…å­˜ï¼‰ï¼ŒCPU è®¿é—®å®ƒä»¬éœ€è¦ä¸Šç™¾ä¸ªå‘¨æœŸï¼›è€Œç£ç›˜å­˜å‚¨è¢«ç”¨æ¥ä¿å­˜å¤§é‡æ•°æ®ï¼Œç£ç›˜è¯»æ¯” SRAM æ…¢äº†è¶³è¶³ 100 ä¸‡å€ã€‚</p><p>å³ä½¿é€Ÿåº¦å·®è·å¦‚æ­¤ä¹‹å¤§ï¼Œè®¡ç®—æœºçš„ä¸»è¦å­˜å‚¨è®¾å¤‡ä»ç„¶æ˜¯ DRAMï¼ˆå†…å­˜ï¼‰å’Œç£ç›˜ï¼ˆæˆ–è€… SSDï¼‰ã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼ŒSRAM è™½ç„¶æ€§èƒ½å¼ºåŠ²ï¼Œå´ä¹Ÿååˆ†æ˜‚è´µï¼ŒCPU æ—è¾¹çš„é«˜é€Ÿç¼“å­˜å®¹é‡ä¸€èˆ¬ä¹Ÿå°±å‡ ç™¾ KBï¼Œæˆ–è€…å‡  MBã€‚å®ƒä»¬ä¹‹é—´çš„é€Ÿåº¦å·®å¼‚å¯ä»¥ç”¨<a href="https://zh.wikipedia.org/wiki/%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%B1" target="_blank" rel="noopener noreferrer">å­˜å‚¨å™¨å±±<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ¥ç›´è§‚çš„å±•ç¤ºï¼š</p><p><img src="/assets/å­˜å‚¨å™¨å±±-a2dcd0b7.jpeg" alt="å­˜å‚¨å™¨å±±"></p><p>è®¡ç®—æœºå¾€å¾€æ˜¯å¤šç§å­˜å‚¨è®¾å¤‡å…±å­˜ï¼Œç›¸äº’ååŠ©è®© CPU å……åˆ†å‘æŒ¥å…¶æ€§èƒ½ã€‚è€Œå†…å­˜ï¼ˆMain Memoryï¼Œä¹Ÿç§°ä¸»å­˜ï¼‰ä½œä¸ºå±±ä¸­æœ€æ ¸å¿ƒçš„ä¸€å±‚ï¼Œæ‹…ä»»ç€<strong>ç¼“å†²</strong>ä¸<strong>åŠ é€Ÿ</strong>çš„é‡è¦å·¥ä½œï¼Œå…¶é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚</p><p>ä¹Ÿå› æ­¤ï¼Œ<strong>å†…å­˜ç®¡ç†</strong> æ¨¡å—æ˜¯æ“ä½œç³»ç»Ÿã€ç¼–ç¨‹è¯­è¨€ä¸­æä¸ºé‡è¦ä¸”ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚</p><blockquote><p>æ“ä½œç³»ç»Ÿå¯¹å†…å­˜çš„æŠ½è±¡å’Œç®¡ç†æ˜¯å¾ˆå¤æ‚çš„ï¼Œé‡Œé¢æ¶‰åŠåˆ°å¤§é‡æ¦‚å¿µå’Œæœºåˆ¶<br> (æ¯”å¦‚è™šæ‹Ÿå†…å­˜ã€åˆ†é¡µã€æƒé™ã€ç¼ºé¡µä¸­æ–­ç­‰ç­‰)ï¼Œä¸ç†Ÿæ‚‰çš„åŒå­¦<br> å¯ä»¥ç‚¹å‡»<a href="https://zhuanlan.zhihu.com/p/152119007" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å›é¡¾ä¸€ä¸‹ã€‚ ç¼–ç¨‹è¯­è¨€å·¥ä½œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ‰€ç®¡ç†çš„å†…å­˜åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸Šï¼Œå› æ­¤ç¬”è€…<br> ä¸ä¼šä»‹ç»åœ°å€ç©ºé—´ä¹‹ä¸‹çš„å†…å®¹ã€‚</p></blockquote><h2 id="å†…å­˜å¸ƒå±€" tabindex="-1"><a class="header-anchor" href="#å†…å­˜å¸ƒå±€" aria-hidden="true">#</a> å†…å­˜å¸ƒå±€</h2><p>å¯¹äºä¸€ä¸ªç¨‹åºè€Œè¨€ï¼Œå½“å…¶ä»¥è¿›ç¨‹çš„å½¢å¼è¢«åˆ›å»ºæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºå…¶åˆ†é…ä¸€ç‰‡å·¨å¤§çš„è™šæ‹Ÿå†…å­˜ï¼Œè¢«ç§°ä¸ºåœ°å€ç©ºé—´ã€‚å¦‚ä¸‹ï¼š</p><img alt="åœ°å€ç©ºé—´" src="/assets/åœ°å€ç©ºé—´1-e6d719f6.png" width="50%" height="50%" style="margin:0 auto;"><p>å¦‚å›¾æ‰€ç¤ºï¼Œå†…å­˜ç©ºé—´è¢«åˆ’åˆ†ä¸ºäº†å¤šä¸ªåŒºï¼š</p><ul><li>æ ˆåŒº(Stack)ï¼šå­˜å‚¨æ‰§è¡ŒæœŸé—´çš„å±€éƒ¨å˜é‡ã€å‚æ•°ç­‰ï¼Œä»é«˜åœ°å€å‘åœ°å€å¢é•¿ï¼›</li><li>å †åŒº(Heap)ï¼šåŠ¨æ€å†…å­˜åˆ†é…åŒºï¼Œä¹Ÿæ˜¯å†…å­˜ç®¡ç†çš„ä¸»æˆ˜åœºï¼›</li><li>æ•°æ®åŒº(BSSã€Data)ï¼šæ•°æ®åŒºå¯ä»¥åˆ’åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼ŒBSS è¡¨ç¤ºå­˜å‚¨ä½†æœªè¢«åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œè€Œ Data åŒºè¡¨ç¤ºå·²ç»åˆå§‹åŒ–å®Œæ¯•çš„å…¨å±€ã€é™æ€å˜é‡ï¼›</li><li>ä»£ç åŒº(Text)ï¼šå­˜å‚¨åªè¯»çš„æœºå™¨æŒ‡ä»¤ã€‚</li></ul><p>æŒ‰ç…§è¿™äº›åŒºå„è‡ªçš„ç‰¹ç‚¹ï¼Œä»£ç åŒºçš„æŒ‡ä»¤ä¼šè‡ªåŠ¨æ ¹æ® PC å¯„å­˜å™¨çš„å€¼åŠ è½½è‡³ CPU å¹¶è¿è¡Œï¼Œæ ˆåŒºç”¨äºä¿å­˜å±€éƒ¨å˜é‡ã€å‚æ•°ï¼Œå†…å­˜ä¼šè‡ªåŠ¨éšç€å‡½æ•°è°ƒç”¨è€Œå¼€è¾Ÿå’Œé‡Šæ”¾ï¼Œæ•°æ®åŒºçš„å†…å­˜ç”±äºæ˜¯å…¨å±€ã€é™æ€å˜é‡ï¼Œå› æ­¤ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾è°ƒï¼Œå®ƒä»¬åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å°±å·²ç»è¢«åˆ†é…äº†ï¼Œåœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¸€ç›´å­˜åœ¨ã€‚</p><p>è€Œå‰©ä¸‹çš„<strong>å †åŒº</strong>åˆ™æ˜¯ç¨‹åºå†…å­˜ç®¡ç†çš„æœ€ä¸»è¦æˆ˜åœºäº†ï¼Œäº‹å®ä¸Šå †å†…å­˜ä¹Ÿå æ®äº†åœ°å€ç©ºé—´ä¸Šæœ€å¤§çš„ä¸€å—ã€‚å †å†…å­˜å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>ç”Ÿå‘½å‘¨æœŸçµæ´»ï¼Œç”±ç”¨æˆ·ç¨‹åºè‡ªå·±ç®¡ç†ï¼›</li><li>å¤§å°å¯å˜ï¼Œå¯æŒ‰å—åˆ†é…å¤§å†…å­˜ï¼Œä¹Ÿå¯æŒ‰å­—èŠ‚åˆ†é…å°å†…å­˜ï¼›</li><li>æŒ‰éœ€åˆ†é…ï¼Œç”± sbrk æŒ‡é’ˆç®¡ç†ï¼ŒæŒ‡é’ˆä¸Šç§»åˆ™å¼€è¾Ÿå†…å­˜ï¼Œä¸‹ç§»åˆ™é‡Šæ”¾å†…å­˜ï¼›</li></ul><p>å †å†…å­˜è™½ç„¶çµæ´»ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼š</p><ol><li>å¦‚æœå¼€è¾Ÿçš„å†…å­˜æœªä½¿ç”¨ï¼Œä½†ä¹Ÿæœªé‡Šæ”¾ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼›</li><li>å¦‚æœå¼€è¾Ÿçš„å†…å­˜ä»åœ¨ä½¿ç”¨ï¼Œä½†è¢«é‡Šæ”¾äº†ï¼Œå°±ä¼šé€ æˆæ‚¬æŒ‚æŒ‡é’ˆã€‚</li></ol><p>è¿™äº›å†…å­˜é—®é¢˜ä¹Ÿä¸€ç›´å›°æ‰°ç€ C/C++ç¨‹åºå‘˜ä»¬ï¼Œå°¤å…¶æ˜¯åˆå­¦è€…ã€‚</p><h2 id="ç®¡ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#ç®¡ç†æ–¹å¼" aria-hidden="true">#</a> ç®¡ç†æ–¹å¼</h2><p>æ—¢ç„¶å†…å­˜ç®¡ç†å¦‚æ­¤é‡è¦ï¼Œå› æ­¤å‡ ä¹æ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½å°†å†…å­˜ç®¡ç†å†…ç½®åˆ°äº†è¯­è¨€ä¸­ï¼Œè€Œå®ƒä»¬çš„ç®¡ç†æ–¹å¼å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p><ul><li>æ‰‹åŠ¨ç®¡ç†ï¼šå¦‚ C ä¸­ malloc/free å‡½æ•°åˆ†åˆ«ç”¨æ¥å¼€è¾Ÿã€é‡Šæ”¾å†…å­˜ï¼›</li><li>è‡ªåŠ¨ç®¡ç†ï¼šå¦‚ Javaã€Goã€Python ç­‰å†…ç½®äº†åƒåœ¾å›æ”¶å™¨(GC)æ¥è¿½è¸ªå†…å­˜ä½¿ç”¨ï¼Œè‡ªåŠ¨é‡Šæ”¾æœªç”¨çš„å†…å­˜ï¼ˆåƒåœ¾ï¼‰ã€‚</li></ul><h3 id="æ‰‹åŠ¨ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#æ‰‹åŠ¨ç®¡ç†" aria-hidden="true">#</a> æ‰‹åŠ¨ç®¡ç†</h3><p>æ‰‹åŠ¨å†…å­˜ç®¡ç†åº”è¯¥ç®—æ˜¯å†…å­˜ç®¡ç†çš„ç»å…¸æµæ´¾äº†ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å……åˆ†ä¿¡ä»»ç¨‹åºå‘˜ï¼Œå¾…ç¨‹åºéœ€è¦æ›´å¤šå†…å­˜æ—¶ï¼Œé€šè¿‡ malloc(æˆ–è€… new) å‡½æ•°æ¥å¼€è¾Ÿå†…å­˜ï¼Œå½“å†…å­˜ä¸å†éœ€è¦çš„æ—¶å€™ï¼Œè°ƒç”¨ free(æˆ–è€… delete) å‡½æ•°æ¥é‡Šæ”¾ã€‚</p><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé«˜ç´ è´¨çš„å·¥ç¨‹å¸ˆä¸ä»…èƒ½åˆç†å®Œæˆä¸šåŠ¡éœ€æ±‚ï¼Œè¿˜è¦å¯¹ç¨‹åºå†…å­˜ä½¿ç”¨åšåˆ°ç²¾å‡†ç®¡ç†ï¼Œè¿™æ ·å†…å­˜ä¸ä»…èƒ½å¤Ÿå¾—åˆ°å®Œå–„çš„ç®¡ç†ï¼Œä¹Ÿä¸ä¼šé€ æˆå†…å­˜å®‰å…¨é—®é¢˜ã€‚</p><p>C/C++ æ˜¯æ‰‹åŠ¨å†…å­˜ç®¡ç†è¯­è¨€çš„ä»£è¡¨ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment">// å¼€è¾Ÿå†…å­˜</span>
   <span class="token keyword">int</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ç”¨å®Œåé‡Šæ”¾</span>
   <span class="token function">free</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// output:</span>
<span class="token comment">// 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªç®€å•çš„ C è¯­è¨€ä¾‹å­ä¸­ï¼Œå¼€å‘è€…å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ malloc æ¥ä¸ºå˜é‡ <code>a</code> åˆ†é…å†…å­˜ï¼Œå¾…ä½¿ç”¨å®Œåï¼Œåˆéœ€è¦æ‰‹åŠ¨è°ƒç”¨ free å°†å†…å­˜è¿˜ç»™è¿›ç¨‹ã€‚</p><p>è¯•æƒ³ä¸€ä¸‹ï¼Œå¯¹äºå°‘é‡çš„å˜é‡ï¼Œç²¾å‡†æ§åˆ¶å®ƒä»¬çš„åˆ†é…ä¸é‡Šæ”¾æ˜¯è¾ƒä¸ºç®€å•çš„ï¼Œå¯æ˜¯ä¸€æ—¦ä»£ç é‡æ€¥å‰§æ”€å‡ï¼Œå˜é‡ä¹Ÿæå…·æ”€å‡ï¼Œè€Œäººçš„ç²¾åŠ›æ€»æ˜¯æœ‰é™çš„ï¼Œéš¾å…ä¼šå‡ºç°é”™è¯¯å¯¼è‡´å†…å­˜é—®é¢˜ã€‚</p><p>è€Œä¸”å¾ˆå¤šæ—¶å€™ï¼Œä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œå¼€å‘è€…è¿˜éœ€æŠ‰æ‹©å†…å­˜æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼Œè¿˜æ˜¯æ ˆä¸Šåˆ†é…ï¼Œå¦‚æ­¤æœºæ¢°çš„å¼€è¾Ÿã€é‡Šæ”¾å·¥ä½œæ— ç–‘ä¼šå å¼€å‘è€…å¾ˆå¤šçš„æ—¶é—´å’Œç²¾åŠ›ã€‚</p><p>C++ä¸ºäº†æ”¹å–„ä¸€ç‚¹ï¼Œå¼•å…¥äº†æ„é€ ã€ææ„å‡½æ•°ï¼Œæ™ºèƒ½æŒ‡é’ˆï¼ˆæœ¬è´¨ä¸Šæ˜¯å¼•ç”¨è®¡æ•°ï¼‰æ¥æ”¹å–„å†…å­˜çš„è‡ªåŠ¨ç®¡ç†ï¼Œä¸€äº› C++çš„æ‹¥è¶¸è€…è§‰å¾—è¿™å·²ç»å¤Ÿäº†ï¼Œä½†æ›´å¤šçš„äººè§‰å¾—è¿™ä¸å¤Ÿï¼Œå› æ­¤ä»–ä»¬å¼•å…¥äº†çº¯è‡ªåŠ¨å†…å­˜ç®¡ç†çš„ç¼–ç¨‹è¯­è¨€ã€‚</p><h3 id="è‡ªåŠ¨ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨ç®¡ç†" aria-hidden="true">#</a> è‡ªåŠ¨ç®¡ç†</h3><p>è‡ªåŠ¨å†…å­˜ç®¡ç†å‡ ä¹æ˜¯ç°ä»£è¯­è¨€çš„æ ‡å‡†ï¼Œç¬¬ä¸€ä¸ªä½¿ç”¨å†…å­˜è‡ªåŠ¨ç®¡ç†çš„è¯­è¨€æ˜¯ <a href="https://en.wikipedia.org/wiki/Lisp_(programming_language)" target="_blank" rel="noopener noreferrer">Lisp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œå®ƒçš„ä½œè€… John ä¸ºå…¶å®ç°äº†ä¸€ä¸ªéå¸¸ç®€å•çš„ GC(Garbage Collection)ç®—æ³•ï¼Œè¢«ç§°ä¸ºæ ‡è®°æ¸…ç†ç®—æ³•(Mark-Sweep)ã€‚</p><p>è¿™ä¸ªç®—æ³•ç®¡ç†å†…å­˜çš„æ€è·¯å¾ˆç®€å•ï¼š</p><ol><li>æ ‡è®°ï¼šå®æ—¶è¿½è¸ªç¨‹åºå˜é‡ï¼Œæ ‡è®°å‡ºå¯è¾¾å¯¹è±¡ï¼›</li><li>æ¸…ç†ï¼šæ ‡è®°å®Œæˆåï¼Œæœªæ ‡è®°çš„å¯¹è±¡éƒ½æ˜¯ä¸å¯è¾¾çš„ï¼Œå¯ä»¥ä½œä¸ºåƒåœ¾æ¸…ç†æ‰ã€‚</li></ol><p>è¿™ä¸ªç®—æ³•æ€è·¯è™½ç„¶ç®€å•ï¼Œä½†è‡³ä»Šä»åœ¨ä½¿ç”¨ï¼Œæ˜¯å­¦ä¹  GC ç®—æ³•çš„å¿…ç»ä¹‹è·¯ã€‚å½“ç„¶ GC ç®—æ³•è¿˜æœ‰å¾ˆå¤šï¼Œæ¯ä¸ªè¯­è¨€çš„å®ç°ä¸å°½ç›¸åŒï¼Œåæ–‡æˆ‘ä»¬å†æ¥ç»†è°ˆã€‚</p><p>å†…å­˜ä»æ‰‹åŠ¨ç®¡ç†åˆ°è‡ªåŠ¨ç®¡ç†æ˜¯è¯­è¨€çš„ä¸€å¤§æ­¥ï¼Œè¿™ç§æœºåˆ¶å½»åº•è§£æ”¾äº†å¼€å‘è€…ä»¬ï¼Œå¹¶ä¸”è®©æ™®é€šäººå¼€å§‹ç€æ‰‹å†™ä»£ç ï¼Œä½“éªŒåˆ›é€ çš„ä¹è¶£ã€‚æ­¤åï¼Œå·¥ç¨‹å¸ˆåªéœ€å°†ç²¾åŠ›é›†ä¸­åœ¨æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ä¸Šï¼Œæ— ç–‘è¿™æå‡äº†å¼€å‘æ•ˆç‡ã€‚</p><p>ä½†å¥½ä¸œè¥¿éƒ½æ˜¯æœ‰ä»£ä»·çš„ï¼Œå†…å­˜è‡ªåŠ¨ç®¡ç†è™½ç„¶å¸®åŠ©å¼€å‘è€…èŠ‚çº¦äº†æ—¶é—´å’Œç²¾åŠ›ï¼Œè§£å†³äº†åŸºæœ¬çš„å†…å­˜é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€å®šé‡çš„æ€§èƒ½æŸå®³ï¼Œè¿™å…¶ä¸­å°±æœ‰æœ€è‡­åæ˜­ä¸¾çš„ STW(Stop The World)é—®é¢˜ã€‚</p><h2 id="å†…å­˜ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#å†…å­˜ç®¡ç†" aria-hidden="true">#</a> å†…å­˜ç®¡ç†</h2><p>åœ¨å¯¹å†…å­˜ã€å†…å­˜å¸ƒå±€ã€å†…å­˜ç®¡ç†ç®€å•ä»‹ç»åï¼Œæˆ‘ä»¬è¿›å…¥çœŸæ­£çš„æ­£æ–‡éƒ¨åˆ†ï¼šç”¨ Go æ¥å®ç°å†…å­˜ç®¡ç†ã€‚</p><p>è‚¯å®šå¾ˆå¤šäººè§‰å¾— Go æ˜¯ä¸€é—¨è‡ªå¸¦ GC çš„è¯­è¨€ï¼Œæœ‰å¿…è¦å†å»ç®¡ç†å…¶å†…å­˜å—ï¼Ÿ</p><p>ç†è®ºä¸Šæ¥è¯´ï¼Œæ˜¯ä¸éœ€è¦çš„ï¼Œä½†æœ€è¿‘ä¸€æ®µæ—¶é—´ç¬”è€…åˆ†åˆ«çœ‹åˆ°äº†ä¸‰ç¯‡æ–‡ç« ï¼Œå®ƒä»¬ä¸çº¦è€ŒåŒåœ°æŒ‡å‘äº†ä¸€ä»¶äº‹æƒ…ï¼šGo çš„ GC ä¸ç¨³å®šï¼Œæˆ‘ä»¬éœ€è¦å¦å¤–çš„å†…å­˜ç®¡ç†æ–¹å¼ã€‚</p><p>è¿™ä¸‰ç¯‡æ–‡ç« åˆ†åˆ«æ˜¯ï¼š</p><ol><li><p>2019 å¹´ Ross åœ¨ twitch ä¸Šå‘è¡¨äº†ä¸€ç¯‡åä¸º<a href="https://blog.twitch.tv/en/2019/04/10/go-memory-ballast-how-i-learnt-to-stop-worrying-and-love-the-heap/" target="_blank" rel="noopener noreferrer">Go memory ballast: How I learnt to stop worrying and love the heap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„æ–‡ç« ï¼›Ross æå‡ºäº†ä¸€ç§ ballast çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œæ˜¾è‘—åœ°é™ä½äº† GC å¸¦æ¥çš„å»¶æ—¶ã€‚</p></li><li><p>2022 å¹´ 2 æœˆï¼Œdanscales åœ¨ Go çš„å®˜æ–¹ Github ä»“åº“ä¸Šæå‡ºäº†ä¸€ä¸ªåä¸º<a href="https://github.com/golang/go/issues/51317" target="_blank" rel="noopener noreferrer">proposal: arena: new package providing memory arenas<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„ææ¡ˆï¼Œè¿™ä¸ªææ¡ˆå¸Œæœ› Go èƒ½æä¾›ä¸€ç§æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„ Area APIã€‚</p></li><li><p>åŒæ ·åœ¨ 2022 å¹´ 2 æœˆï¼Œheiyeluren åœ¨ Github ä¸Šå¼€æºäº†ä¸€ä¸ªåä¸º<a href="https://github.com/heiyeluren/xmm" target="_blank" rel="noopener noreferrer">XMM<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„ Go ä¸‰æ–¹å†…å­˜ç®¡ç†åº“ï¼Œæ—¨åœ¨å®Œç¾é€ƒé€¸æ‰ Go çš„å†…å­˜ GC æœºåˆ¶ï¼Œæ„å»ºé«˜æ€§èƒ½åŸºç¡€è®¾æ–½ã€‚</p></li></ol><p>å—è¿™ 3 ç¯‡æ–‡ç« çš„å¯å‘ï¼Œä»¥åŠæŠ±ç€å¯¹å†…å­˜ç®¡ç†çš„å…´è¶£ï¼Œç¬”è€…å†³å®šåœ¨ Go ä¸Šåˆ†åˆ«å®ç°æ‰‹åŠ¨ã€è‡ªåŠ¨å†…å­˜ç®¡ç†ä¸¤ç§æ–¹å¼ï¼Œä»¥æ­¤ä¸ºå¥‘æœºæ¥æ·±å…¥ç†è§£ Go çš„å†…å­˜ç®¡ç†ã€‚</p><h3 id="å†…å­˜åˆ†é…åŸç†" tabindex="-1"><a class="header-anchor" href="#å†…å­˜åˆ†é…åŸç†" aria-hidden="true">#</a> å†…å­˜åˆ†é…åŸç†</h3><p>åœ¨å‰é¢çš„<a href="##%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">å†…å­˜å¸ƒå±€</a>ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°å†…å­˜ç®¡ç†çš„æœ€ä¸»è¦æ¨¡å—æ˜¯å †å†…å­˜ã€‚ç”±äºæ˜¯è™šæ‹Ÿå†…å­˜ï¼Œè¿™ä¸ªå †éå¸¸å¤§ï¼Œç°é˜¶æ®µå‡ ä¹ä¸å¯èƒ½ç”¨å®Œï¼Œå› æ­¤æš‚æ—¶æ— éœ€è€ƒè™‘å †è¶Šç•Œçš„é—®é¢˜ã€‚</p><p>å †(heap)å­˜åœ¨äºè¿›ç¨‹åœ°å€ç©ºé—´ä¸­ï¼Œè€Œè¿›ç¨‹åœ°å€ç©ºé—´(mm)åˆè¢«å®šä¹‰åœ¨è¿›ç¨‹(task_struct)ä¸­ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img alt="å…³ç³»å›¾" src="/assets/è¿›ç¨‹åœ°å€ç©ºé—´å †å…³ç³»å›¾-0bbad066.png" width="50%" height="50%" style="margin:0 auto;"><p>åœ¨ä»£ç å±‚é¢ä¸Šï¼Œä»¥ Linux æ“ä½œç³»ç»Ÿä¸ºä¾‹ï¼Œå®ƒä»¬ä¹‹é—´çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   <span class="token keyword">struct</span> <span class="token class-name">thread_info</span> thread_info<span class="token punctuation">;</span> <span class="token comment">// å¤„ç†å™¨ç‰¹æœ‰æ•°æ®</span>
   <span class="token comment">// ...</span>
   <span class="token keyword">struct</span> <span class="token class-name">mm_struct</span>        <span class="token operator">*</span>mm<span class="token punctuation">;</span>  <span class="token comment">// æŒ‡å‘è¿›ç¨‹å†…å­˜ç»“æ„</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">mm_struct</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   <span class="token comment">// è¿›ç¨‹åº”ç”¨ç¨‹åºå †åŒºçš„å¼€å§‹ã€å½“å‰åœ°å€ã€æ ˆå¼€å§‹åœ°å€</span>
   <span class="token keyword">unsigned</span> <span class="token keyword">long</span> start_brk<span class="token punctuation">,</span> brk<span class="token punctuation">,</span> start_stack<span class="token punctuation">;</span>
   <span class="token comment">// è¿›ç¨‹åº”ç”¨ç¨‹åºå‚æ•°åŒºå¼€å§‹ã€ç»“æŸåœ°å€</span>
   <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg_start<span class="token punctuation">,</span> arg_end<span class="token punctuation">,</span> env_start<span class="token punctuation">,</span> env_end<span class="token punctuation">;</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç é‡Œï¼Œç¬”è€…å·²ç»æ³¨é‡Šäº†ä¸å †ç›¸å…³çš„ä¸¤ä¸ªå˜é‡ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>start_brkï¼šå †å¼€å§‹åœ°å€ï¼›</li><li>brkï¼šå †å½“å‰åœ°å€ã€‚</li></ul><p>ä»¥è¿›ç¨‹çš„è§†è§’æ¥çœ‹ï¼Œç®¡ç†å †å…¶å®å°±æ˜¯ç§»åŠ¨ brk è¿™ä¸ªåœ°å€æŒ‡é’ˆï¼Œstart_brk åœ¨åˆ›å»ºåå°±ä¸ä¼šæ”¹å˜ï¼›brk æŒ‡é’ˆå¢åŠ ï¼Œè¡¨ç¤ºåˆ†é…å †å†…å­˜ï¼Œbrk æŒ‡é’ˆå‡å°‘ï¼Œåˆ™ä¼šé‡Šæ”¾å †å†…å­˜ã€‚å¦‚ä¸‹ï¼š</p><img alt="å †å†…å­˜ç®¡ç†" src="/assets/å †å†…å­˜ç®¡ç†-eea06083.png" width="50%" height="50%" style="margin:0 auto;"><p>ä»¥åº”ç”¨ç¨‹åºçš„è§†è§’æ¥çœ‹ï¼Œç®¡ç†å†…å­˜çš„æœ¬è´¨å®è´¨å°±æ˜¯é€šè¿‡è¿›ç¨‹æä¾›çš„ API æ¥ç§»åŠ¨ brk æŒ‡é’ˆï¼Œè€Œè¿™ä¸ª API å°±æ˜¯è‘—åçš„ BRK APIï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>                 BRK(2)
NAME
       brk, sbrk - change data segment size

SYNOPSIS
       #include &lt;unistd.h&gt;

       int brk(void *addr);

       void *sbrk(intptr_t increment);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥å‡½æ•° <code>sbrk</code> ä¸ºä¾‹ï¼Œå…¶æ¥æ”¶ä¸€ä¸ªå‚æ•° <code>increment</code>ï¼Œå½“ increment å¤§äº 0 æ—¶ï¼Œåˆ™å°† brk æŒ‡é’ˆå‘ä¸Šç§»åŠ¨ï¼Œå°äº 0 æ—¶ï¼Œåˆ™å‘ä¸‹ç§»åŠ¨ï¼Œè°ƒç”¨æˆåŠŸåè¿”å›åˆ†é…åœ°å€çš„å†…å­˜ï¼Œè°ƒç”¨å¤±è´¥åˆ™è¿”å› -1ã€‚</p><p>æˆ‘ä»¬æ¥å®æ“ä¸€ä¸‹ï¼Œçœ‹ sbrk æ˜¯å¦èƒ½çœŸçš„åˆ†é…å†…å­˜ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">/*
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

static void* Sbrk(int size) {
	void *r = sbrk(size);
	if(r == (void *)-1){
  		return NULL;
 	}
	return r;
}
*/</span>
<span class="token keyword">import</span> <span class="token string">&quot;C&quot;</span>
<span class="token comment">// ... çœç•¥</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mem <span class="token operator">:=</span> C<span class="token punctuation">.</span><span class="token function">Sbrk</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡Œç¨‹åºï¼Œä¼šå¾—åˆ°ä»¥ä¸‹è¾“å‡º(å¾—åˆ°çš„å†…å­˜åœ°å€å¯èƒ½ä¸åŒ)ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0xba00000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™è¯´æ˜ï¼Œsbrk ç¡®å®çœŸæ­£çš„å‘è¿›ç¨‹ç”³è¯·åˆ°äº†å†…å­˜ï¼Œè€Œè¿™ä¸ªå†…å­˜æ˜¯å¯ä»¥ç›´æ¥è¯»å†™çš„ã€‚</p><p>é™¤äº†è¿™ç§æ–¹å¼ï¼Œæ“ä½œç³»ç»Ÿè¿˜æä¾›å¦å¤–çš„ä¸€ç§ç³»ç»Ÿè°ƒç”¨ <code>mmap</code> ä¹Ÿèƒ½è¾¾åˆ°ç”³è¯·å †å†…å­˜çš„æ•ˆæœï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>NAME
       mmap, munmap - map or unmap files or devices into memory

SYNOPSIS
       #include &lt;sys/mman.h&gt;

       void *mmap(void *addr, size_t length, int prot, int flags,
                  int fd, off_t offset);
       int munmap(void *addr, size_t length);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶ï¼Œmmap çš„å®ç°æœºåˆ¶ä¸ sbrk æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œè€Œä¸”ç”¨é€”æ›´å¤šï¼Œç®€å•è€Œè¨€ï¼Œå®ƒä¼šæ˜ å°„å †ä¸­çš„ä¸€å—å†…å­˜ä¾›ç¨‹åºæ“çºµï¼Œè¿™å—å†…å­˜å¤§å°ç”±å‚æ•°æ§åˆ¶ï¼Œå› æ­¤å¯ä»¥æå‰ç”³è¯·ä¸€å¤§å—å†…å­˜ï¼Œç„¶åç”¨è¿™å—å†…å­˜æ¥ç”¨äºç¨‹åºå…¶å®ƒæ•°æ®çš„åˆ†é…ã€‚</p><blockquote><p>mmap çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæœ¬æ–‡çš„é‡ç‚¹æ˜¯ç®€å•ä½¿ç”¨å®ƒï¼Œå› æ­¤å…³äºå®ƒçš„å…¶å®ƒç”¨æ³•ï¼Œæˆ–è€…å®ç°æœºåˆ¶å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚<br> å¦å¤–æ— è®ºæ˜¯ sbrk è¿˜æ˜¯ mmap çœ‹ä¼¼éƒ½ä»å †é‡Œé¢åˆ†é…äº†å†…å­˜ï¼Œä½†å®é™…ä¸Šè¿™äº›éƒ½æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œè€Œå½“ç¨‹åºä½¿ç”¨å†…å­˜æ—¶ï¼Œç‰©ç†å†…å­˜æ‰ä¼šçœŸæ­£çš„åˆ†é…ï¼Œè¿™ç§æ‡’åŠ è½½çš„æœºåˆ¶è¢«ç§°ä¸ºç¼ºé¡µä¸­æ–­(demand paging)ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹ç›¸å…³çš„èµ„æ–™ã€‚</p></blockquote><p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬åœ¨ C ä¸­ä½¿ç”¨çš„ malloc/free ä¸¤ä¸ªå‡½æ•°å†…éƒ¨çš„éƒ½æ˜¯é€šè¿‡è°ƒç”¨ sbrkï¼Œmmap ç­‰ API æ¥åˆ†é…ã€é‡Šæ”¾å†…å­˜çš„ã€‚</p><p>å¦å¤–ï¼Œå¯¹äº C è€Œè¨€ï¼Œæ ‡å‡†åº“æä¾›çš„ malloc/free API æ˜¯ç”± glibc å®ç°çš„ï¼Œè€Œå†…å­˜åˆ†é…æ˜¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆæ£˜æ‰‹çš„é—®é¢˜ï¼Œä¸åŒçš„åœºæ™¯ä¸‹æœ‰ä¸åŒçš„åˆ†é…ç®—æ³•å®ç°ï¼Œæ¯”å¦‚å¦å¤–ä¸¤ä¸ªæ¯”è¾ƒçŸ¥åçš„å®ç°ï¼š<a href="https://github.com/jemalloc/jemalloc" target="_blank" rel="noopener noreferrer">jemalloc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å’Œ<a href="https://github.com/google/tcmalloc" target="_blank" rel="noopener noreferrer">tcmalloc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚å®ƒä»¬å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å¼€çœ‹çœ‹ã€‚</p><h3 id="gc-å®è·µ" tabindex="-1"><a class="header-anchor" href="#gc-å®è·µ" aria-hidden="true">#</a> GC å®è·µ</h3><p>åœ¨ Go ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å‡ ä¹ä¸ç”¨å…³æ³¨å†…å­˜ç®¡ç†ï¼Œruntime(è¿è¡Œæ—¶)ä¼šä¸ºç¨‹åºæ¥ç®¡è¿›ç¨‹å†…å­˜ï¼Œå½“éœ€è¦å†…å­˜åˆ†é…å¯¹è±¡æ—¶ï¼Œç›´æ¥æ–°å»ºå¯¹è±¡å³å¯ï¼Œå½“å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶ï¼Œä¼šè¢«è‡ªåŠ¨å›æ”¶æ‰(GC) ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pid <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;process: %d\n&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> overall <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		a <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
		overall <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>overall<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
		<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	overall <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	runtime<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// PrintMemUsage è¾“å‡ºå½“å‰ç¨‹åºå†…å­˜æƒ…å†µ</span>
<span class="token keyword">func</span> <span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> m runtime<span class="token punctuation">.</span>MemStats
	runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span>
	<span class="token comment">// For info on each, see: https://golang.org/pkg/runtime/#MemStats</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Alloc = %v MiB&quot;</span><span class="token punctuation">,</span> <span class="token function">bToMb</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Alloc<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\tTotalAlloc = %v MiB&quot;</span><span class="token punctuation">,</span> <span class="token function">bToMb</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>TotalAlloc<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\tSys = %v MiB&quot;</span><span class="token punctuation">,</span> <span class="token function">bToMb</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Sys<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\tNumGC = %v\n&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>NumGC<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">bToMb</span><span class="token punctuation">(</span>b <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> b <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡Œè¯¥ç¨‹åºï¼Œä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
process: 1855
Alloc = 50 MiB  TotalAlloc = 50 MiB     Sys = 60 MiB    NumGC = 1
Alloc = 100 MiB TotalAlloc = 100 MiB    Sys = 114 MiB   NumGC = 2
Alloc = 150 MiB TotalAlloc = 150 MiB    Sys = 168 MiB   NumGC = 2
Alloc = 200 MiB TotalAlloc = 200 MiB    Sys = 222 MiB   NumGC = 2
Alloc = 200 MiB TotalAlloc = 200 MiB    Sys = 223 MiB   NumGC = 3
Alloc = 0 MiB   TotalAlloc = 200 MiB    Sys = 223 MiB   NumGC = 4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç ç¬¬ 8 è¡Œï¼Œé€šè¿‡ make å…³é”®å­—å¤§é‡åˆ†é…å†…å­˜ï¼Œæ¯æ¬¡ 50Mï¼Œå…± 4 æ¬¡ï¼› ä»£ç ç¬¬ 13 è¡Œï¼Œå½“å¯¹è±¡ä¸å†è¢«éœ€è¦æ—¶ï¼Œç›´æ¥ç½®ä¸º nil å³å¯ï¼›æ³¨æ„ï¼šé€šè¿‡æ­¤æ—¶çš„è¾“å‡ºå‘ç°ï¼Œ200M å†…å­˜ä»ç„¶å ç”¨ï¼Œè€Œåœ¨æœ€åçš„ä¸€è¡Œè¾“å‡ºä¸­ï¼Œè¢«åˆ†é…çš„å†…å­˜ç¬é—´å›åˆ°äº† 0Mã€‚ åŸå› åœ¨äºï¼Œä»£ç çš„ç¬¬ 15 è¡Œï¼Œè°ƒç”¨äº† runtime æä¾›çš„ GC å‡½æ•°ï¼Œå›æ”¶æ‰äº†ä¸éœ€è¦çš„åƒåœ¾å¯¹è±¡ã€‚</p><p>é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å·²ç»è§è¯†åˆ°äº† GC çš„å¼ºå¤§èƒ½åŠ›ï¼Œè€Œåœ¨çœŸå®çš„åœºæ™¯ä¸­ï¼Œåº”ç”¨ç¨‹åºæ˜¯ä¸ç”¨æ‰‹åŠ¨è°ƒç”¨ GC çš„(è¿™é‡Œä¹‹æ‰€ä»¥è°ƒç”¨ï¼Œæ˜¯ä¸ºäº†å±•ç¤º)ï¼Œruntime ä¼šè‡ªåŠ¨ç›‘æµ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶æœºè‡ªåŠ¨ GCã€‚</p><p>è¿™æ ·ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†çš„å¥½å¤„å°±æ˜¾ç°å‡ºæ¥äº†ï¼Œå†™ä»£ç æ—¶æ— éœ€å…³æ³¨å†…å­˜çš„å›æ”¶é—®é¢˜ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿå†…å­˜çš„å®‰å…¨é—®é¢˜ï¼Œå°†å…¨éƒ¨ç²¾åŠ›å’Œæ—¶é—´æ”¾åœ¨æ ¸å¿ƒä¸šåŠ¡ä¸Šï¼Œè‡ªç„¶å°±èƒ½æé«˜ä»£ç ã€é¡¹ç›®è´¨é‡ï¼Œä¹Ÿèƒ½è®©ç¨‹åºå‘˜æœä¹æ™šäº”çš„å·¥ä½œ(æ¢¦æƒ³è¿˜æ˜¯è¦æœ‰çš„)ã€‚</p><p>ä½†è¿™ä¸ªä¾‹å­ä¹Ÿæš´éœ²å‡º GC çš„ä¸€ä¸ªé—®é¢˜ï¼šoverall è¢«ç½®ä¸º nil åï¼Œæ˜¾ç„¶æ­¤æ—¶å®ƒè¢«åˆ†é…çš„ 200M å†…å­˜å°±å·²ç»æ˜¯åƒåœ¾ï¼Œä½† runtime å¹¶æ²¡æœ‰ç«‹å³å›æ”¶ï¼Œå› æ­¤è¿™é‡Œæ‰æ‰‹åŠ¨è°ƒç”¨äº† GC å‡½æ•°æ¥å›æ”¶åƒåœ¾ã€‚è€ŒçœŸå®çš„åœºæ™¯è¿œæ¯”è¿™å¤æ‚ï¼Œå¯èƒ½æœ‰å¤§é‡çš„åƒåœ¾æ²¡æœ‰åŠæ—¶å›æ”¶ï¼Œä½†å®ƒä»¬ä»ç„¶å ç”¨äº†å†…å­˜ï¼Œè¿™æ ·å†…å­˜èµ„æºå°±è¢«æµªè´¹äº†ã€‚</p><p>æ›´æ£˜æ‰‹çš„æ˜¯ï¼Œå³ä½¿ runtime å‘ç°äº†å¤§é‡åƒåœ¾ï¼Œæ¯”å¦‚ 200Mï¼Œä½†æ˜¯å›æ”¶åƒåœ¾ä¹Ÿæ˜¯éœ€è¦æ—¶é—´çš„ï¼Œè€Œæ­¤æ—¶ç¨‹åºä»ç„¶è¿è¡Œï¼Œä»æœ‰å¯èƒ½åœ¨åˆ†é…æ–°çš„å¯¹è±¡ï¼Œè¿™æ ·è¾¹å›æ”¶è¾¹å¼€è¾Ÿä¼šéå¸¸å¤æ‚ã€‚å› æ­¤ï¼Œruntime ä¼šé€‰æ‹©æš‚åœç¨‹åºè¿è¡Œï¼Œå›æ”¶æ‰åƒåœ¾åå†æ¢å¤ï¼Œè€Œè¿™ä¸ªæš‚åœå°±æ˜¯ä¸Šæ–‡è°ˆåˆ°çš„ STWï¼›ç›´è§‚ä¸Šï¼ŒSTW çš„æ—¶é—´è¶Šå°‘è‚¯å®šè¶Šå¥½ï¼Œå¦‚æœ STW æ—¶ï¼Œä»æœ‰å¤§é‡ç”¨æˆ·è¯·æ±‚ï¼Œé‚£ä¹ˆæœåŠ¡å°±æ— æ³•æœåŠ¡ç”¨æˆ·ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<a href="https://blog.twitch.tv/en/2019/04/10/go-memory-ballast-how-i-learnt-to-stop-worrying-and-love-the-heap/" target="_blank" rel="noopener noreferrer">Go memory ballast: How I learnt to stop worrying and love the heap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>è¿™æ–‡ç« çš„ä½œè€…è¦æå‡º Go memory ballast æ¥é™ä½ GC æ—¶å»¶çš„åŸå› ã€‚</p><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼èƒ½è®©å†…å­˜é€ƒå¼€ GC çš„é™åˆ¶ï¼Ÿä»è€Œå‡å°‘ STM çš„å‘ç”Ÿã€‚</p><p>æ— ç–‘ï¼Œæ˜¯æœ‰çš„ã€‚Go memory ballast å°±æ˜¯å…¶ä¸­çš„ä¸€ç§æ–¹å¼ï¼Œè€Œä¸”å®ƒçš„åŸç†å¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	big <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">200</span><span class="token punctuation">)</span>
	runtime<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>big<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Go memory ballast ä¼šé¢„å…ˆåˆ†é…ä¸€å¤§å—å†…å­˜ï¼Œå¦‚è¿™é‡Œçš„ 200Mï¼Œç„¶åè°ƒç”¨ runtime.KeepAlive å‡½æ•°ï¼Œè¿™æ · runtime ä¼šä¸€ç›´è®¤ä¸º big è¿™æ®µå†…å­˜æ˜¯å­˜æ´»çš„ï¼Œä¸ä¼šå°è¯•å»å›æ”¶å®ƒã€‚ä»æ­¤ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨ç¨‹åºä¸­æ¥ç®¡ big è¿™æ®µå†…å­˜ï¼Œå¹¶ä¸”æŒ‰éœ€ä½¿ç”¨ï¼Œä¸”æ— éœ€è¢« GC æ‰ï¼Œä»è€Œå‡å°‘ STM çš„å‘ç”Ÿé¢‘ç‡ï¼Œè¿™ç§æ–¹å¼ä¹Ÿè¢« TiDB ç”¨åœ¨äº†ç”Ÿäº§ç¯å¢ƒä¸Šã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ›´åŠ å½»åº•çš„æ–¹å¼æ¥é€ƒå¼€ GCï¼Œæœ‰äº†ä¸Šé¢çš„è¿›ç¨‹å†…å­˜ç®¡ç†çš„é“ºå«ï¼Œè¿™ä¸éš¾æƒ³åˆ°ï¼Œé‚£å°±æ˜¯ç›´æ¥é€šè¿‡ mmap ç³»ç»Ÿè°ƒç”¨å‘è¿›ç¨‹è¦å†…å­˜ï¼Œç»•å¼€ runtime è¿™ä¸€å±‚ã€‚å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pid <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;process: %d\n&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> overall <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Area
	<span class="token comment">// 1216 KB</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		area<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		overall <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>overall<span class="token punctuation">,</span> area<span class="token punctuation">)</span>
		<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	runtime<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">PrintMemUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä¸å†é€šè¿‡ make å‡½æ•°æ¥å‘ runtime ä¸­ç”³è¯·å†…å­˜ï¼Œè€Œæ˜¯ä½¿ç”¨ mmap ç”³è¯·å†…å­˜ï¼Œå°†å…¶åŒ…è£…ä¸º Area è¿”å›ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Area <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	addr      <span class="token builtin">uintptr</span> <span class="token comment">// é¦–åœ°å€</span>
	mem       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>  <span class="token comment">// å†…å­˜</span>
	size      <span class="token builtin">int</span>     <span class="token comment">// å†…å­˜å¤§å°</span>
	allocated <span class="token builtin">int</span>     <span class="token comment">// å·²åˆ†é…å†…å­˜</span>
	blocks    <span class="token builtin">int</span>     <span class="token comment">// å†…å­˜å—ä¸ªæ•°</span>
<span class="token punctuation">}</span>

<span class="token comment">// é€šè¿‡ mmap æ¥åˆ†é…å†…å­˜</span>
<span class="token keyword">func</span> <span class="token function">Init</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Area<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mem<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mmap</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span>
		syscall<span class="token punctuation">.</span>PROT_READ<span class="token operator">|</span>syscall<span class="token punctuation">.</span>PROT_WRITE<span class="token punctuation">,</span>
		syscall<span class="token punctuation">.</span>MAP_ANON<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MAP_PRIVATE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;mmap err: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	hdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>header<span class="token punctuation">)</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
	hdr<span class="token punctuation">.</span>size <span class="token operator">=</span> size <span class="token operator">-</span> headerSize
	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>Area<span class="token punctuation">{</span>
		addr<span class="token punctuation">:</span>      <span class="token function">uintptr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">,</span>
		mem<span class="token punctuation">:</span>       mem<span class="token punctuation">,</span>
		size<span class="token punctuation">:</span>      size<span class="token punctuation">,</span>
		allocated<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		blocks<span class="token punctuation">:</span>    <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿è¡Œç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
process: 19282
Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
Alloc = 0 MiB   TotalAlloc = 0 MiB      Sys = 8 MiB     NumGC = 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å‘ç°ï¼Œæ— è®ºæ€ä¹ˆè°ƒç”¨ mmap å‡½æ•°åˆ†é…å†…å­˜ï¼Œä½† runtime æ‰“å°çš„å†…å­˜æŒ‡æ ‡ä¸€ç›´ä¸º 0ï¼Œè€Œä¸”æ²¡æœ‰è§¦å‘ä»»ä½• GCï¼Œå³ä½¿æ‰‹åŠ¨å»è°ƒç”¨ GCï¼Œä½† GC ä¹Ÿæ²¡æœ‰çœŸæ­£çš„å‘ç”Ÿã€‚</p><p>è¿™ä¹Ÿæ˜ è¯äº†åˆšæ‰è°ˆåˆ°çš„ï¼Œmmap ç»•å¼€äº† runtime è¿™ä¸€å±‚ï¼Œç›´æ¥å‘è¿›ç¨‹è¦å†…å­˜ã€‚</p><h3 id="æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ" tabindex="-1"><a class="header-anchor" href="#æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ" aria-hidden="true">#</a> æ‰‹åŠ¨å†…å­˜ç®¡ç†å®è·µ</h3><p>æ‹¿åˆ°äº†è¿›ç¨‹ä¸‹æ”¾çš„å†…å­˜åï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•ç®¡ç†äº†ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œå€Ÿé‰´[æŠ„]ï¼</p><p>æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä»¿ç…§ C è¯­è¨€å†…å­˜ç®¡ç†ï¼Œå³æ‰‹åŠ¨ç®¡ç†ï¼Œå°†æ‹¿åˆ°çš„å¤§å—å†…å­˜(Area)ä½œä¸ºå†…å­˜èµ„æºç¼“å­˜åœ¨ç¨‹åºä¸­ï¼Œç„¶åéœ€è¦å†…å­˜æ—¶ï¼Œå‘ Area è¯·æ±‚(Alloc)å†…å­˜ï¼Œå¾…å†…å­˜ä½¿ç”¨å®Œæ¯•åï¼Œè°ƒç”¨ Area çš„ Free æ–¹æ³•å°†å†…å­˜æ”¾å…¥ Area ä¸­ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™ç§æ–¹å¼å‡ ä¹å°±æ˜¯ <a href="https://github.com/golang/go/issues/51317" target="_blank" rel="noopener noreferrer">arena: new package providing memory arenas<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ææ¡ˆçš„ç®€å•å®ç°æ–¹å¼äº†ã€‚</p><p>ç°åœ¨ï¼Œæ€¥éœ€è§£å†³çš„é—®é¢˜æ˜¯ï¼šArea å¦‚ä½•ç®¡ç†è¿™ä¸€å¤§å—å†…å­˜ï¼Ÿ</p><h4 id="first-fit" tabindex="-1"><a class="header-anchor" href="#first-fit" aria-hidden="true">#</a> First-fit</h4><p>æˆ‘ä»¬å…ˆé€‰æ‹©ä¸€ç§ç®€å•çš„ç®¡ç†æ–¹å¼ï¼Œé€šè¿‡é“¾è¡¨æ¥ç®¡ç†ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/assets/areaç¤ºæ„å›¾-34b075cd.png" alt="areaç¤ºæ„å›¾"></p><p>å…·ä½“çš„æ–¹æ¡ˆä¸ºï¼š</p><ol><li>å°† Area åˆ†æˆå¾ˆå¤šå°å—ï¼Œæ¯å°å—éƒ½æœ‰ä¸€ä¸ªå¤´éƒ¨(header)æ¥å­˜å‚¨å…ƒæ•°æ®ï¼Œæ¯”å¦‚ï¼šè¯¥å—æ˜¯å¦ä½¿ç”¨ï¼Œå—å¤§å°ï¼Œå¹¶ä¸”å¤´éƒ¨ä¸­è¿˜æœ‰ä¸€ä¸ª next æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå¯åˆ†é…çš„å—ï¼›</li><li>è°ƒç”¨ Area.Alloc æ—¶ï¼Œä»å†…å­˜èµ·å§‹åœ°å€ä¾æ¬¡æ²¿é“¾è¡¨å¯»æ‰¾ï¼Œå½“æ‰¾åˆ°ä¸€ä¸ªå¤§å°åˆé€‚ä¸”æœªè¢«ä½¿ç”¨çš„å†…å­˜å—æ—¶ï¼Œè¿”å›è¯¥å—çš„åœ°å€å³å¯ï¼›</li><li>è°ƒç”¨ Area.Free æ—¶ï¼Œæ‹¿åˆ°è¢«å›æ”¶å—çš„ headerï¼Œå°†å…¶æ ‡è®°ä¸ºå¯ç”¨ã€‚</li></ol><p>å°†å…¶ç¿»è¯‘ä¸ºä»£ç ï¼Œå¯¹äº Allocï¼Œæ¥å— size å‚æ•°ï¼Œå³åˆ†é…å†…å­˜çš„å¤§å°ï¼›ç„¶ååˆ¤æ–­ Area æ˜¯å¦è¿˜æœ‰å¯ç”¨å†…å­˜ï¼Œæ²¡æœ‰åˆ™ç›´æ¥è¿”å›é”™è¯¯ï¼Œç„¶åæ‹¿åˆ° Area çš„é¦–åœ°å€ï¼Œä¾æ¬¡å‘åæœç´¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§å°åˆé€‚ï¼Œä¸”æœªåˆ†é…çš„å—ï¼Œæ‰¾åˆ°åå°†è¯¥å—æ ‡è®°ä¸ºå·²ç”¨ï¼Œå¹¶å°† next æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€å—ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> header <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	size      <span class="token builtin">int</span>     <span class="token comment">// å—å¤§å°</span>
	allocated <span class="token builtin">bool</span>    <span class="token comment">// æ˜¯å¦åˆ†é…</span>
	next      <span class="token operator">*</span>header <span class="token comment">// ä¸‹ä¸€å—</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Area<span class="token punctuation">)</span> <span class="token function">Alloc</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>allocated<span class="token operator">+</span>size<span class="token operator">+</span>headerSize <span class="token operator">&gt;</span> m<span class="token punctuation">.</span>size <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t alloc any more&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	h <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>header<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// å¦‚æœå†…å­˜å·²åˆ†é…ï¼Œä¸”å¤§å°ä¸å¤Ÿï¼Œåˆ™ä¸‹ä¸€ä¸ª</span>
	<span class="token keyword">for</span> h<span class="token punctuation">.</span>allocated <span class="token operator">||</span> h<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> size <span class="token punctuation">{</span>
		h <span class="token operator">=</span> h<span class="token punctuation">.</span>next
	<span class="token punctuation">}</span>
	<span class="token comment">// æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ block</span>
	<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t alloc any more&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	prevSz <span class="token operator">:=</span> h<span class="token punctuation">.</span>size
	cur <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
	p <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>headerSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// ä¸‹ä¸€ä¸ª</span>
	hdr <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>header<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>headerSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	hdr<span class="token punctuation">.</span>size <span class="token operator">=</span> prevSz <span class="token operator">-</span> size <span class="token operator">-</span> headerSize
	h<span class="token punctuation">.</span>size <span class="token operator">=</span> size
	h<span class="token punctuation">.</span>allocated <span class="token operator">=</span> <span class="token boolean">true</span>
	h<span class="token punctuation">.</span>next <span class="token operator">=</span> hdr
	m<span class="token punctuation">.</span>allocated <span class="token operator">+=</span> size <span class="token operator">+</span> headerSize
	m<span class="token punctuation">.</span>blocks<span class="token operator">++</span>
	<span class="token keyword">return</span> p<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äº Free å‡½æ•°åˆ™è¦ç®€å•çš„å¤šï¼Œé€šè¿‡æŒ‡é’ˆæ“ä½œ(æŒ‡é’ˆåç§»)æ‹¿åˆ°å— header åï¼Œå°† allocated æ ‡è®°ä¸º false å³å¯ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Area<span class="token punctuation">)</span> <span class="token function">Free</span><span class="token punctuation">(</span>p unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	h <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>header<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>headerSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span>allocated <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t free %x twice&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	h<span class="token punctuation">.</span>allocated <span class="token operator">=</span> <span class="token boolean">false</span>
	m<span class="token punctuation">.</span>allocated <span class="token operator">-=</span> h<span class="token punctuation">.</span>size <span class="token operator">+</span> headerSize
	m<span class="token punctuation">.</span>blocks<span class="token operator">--</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§ç®€å•çš„å†…å­˜ç®¡ç†æ–¹å¼è¢«ç§°ä¸º <a href="https://www.geeksforgeeks.org/first-fit-allocation-in-operating-systems/" target="_blank" rel="noopener noreferrer">First-fit<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œæ­¤å¤–è¿˜æœ‰ Best-fitï¼ŒNext-fit ç­‰ä¸€äº›åˆ—çš„åˆ†é…ç®—æ³•ã€‚ä¸è¿‡è¿™äº›ç®—æ³•éƒ½ä¸å¤Ÿå¥½ç”¨ï¼Œä¸¾ä¾‹æ¥è¯´ï¼š</p><p><img src="/assets/areacase1-d101d645.png" alt="area case1"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œå— 1 è¾ƒå¤§ï¼Œ50 å­—èŠ‚ï¼Œå— 2 è¾ƒå°ï¼Œ20 å­—èŠ‚ï¼Œä¸”éƒ½å·²ç»è¢«åˆ†é…ï¼›ä¸€æ®µæ—¶é—´åï¼Œå— 1 è¢«é‡Šæ”¾äº†ï¼Œè€Œæ­¤æ—¶ Alloc åˆè¢«è°ƒç”¨äº†ï¼Œä½†åªéœ€ 10 å­—èŠ‚çš„å†…å­˜ï¼ŒæŒ‰ç…§ First-fit çš„åŸåˆ™ï¼Œé‚£ä¹ˆå— 1 å°±åº”è¯¥è¢«è¿”å›ï¼Œé‚£å°±æ„å‘³ç€æœ‰ 40 å­—èŠ‚çš„å†…å­˜æ—¶è¢«æµªè´¹çš„ã€‚</p><p>è¿˜æ¯”å¦‚ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œå°å†…å­˜çš„åˆ†é…å¾ˆé¢‘ç¹ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/assets/areacase2-6d7af2c3.png" alt="area case2"></p><p>ç”±äºå°å†…å­˜çš„å—å¾ˆå°ï¼Œæ¯”å¦‚ 10 å­—èŠ‚ï¼Œè€Œå—çš„å¤´éƒ¨ header ä¹Ÿæ˜¯éœ€è¦å å†…å­˜çš„ï¼Œè¿™æ ·ä¼šæ˜¾å¾—å¤´é‡è„šè½»ï¼Œå¤§é‡çš„å†…å­˜éƒ½è¢«ç”¨äºå­˜å‚¨å…ƒæ•°æ®äº†ï¼Œä¹Ÿä¼šé€ æˆå†…å­˜æµªè´¹ã€‚ç­‰ç­‰ï¼ŒFirst-fit å†…å­˜åˆ†é…ç®—æ³•çš„é—®é¢˜å¾ˆå¤šï¼Œå½“ç„¶ä¹Ÿå› ä¸ºå®ƒæœ€å¤Ÿç®€å•ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å­¦ä¹ å†…å­˜ç®¡ç†å¿…ç»çš„ä¸€æ­¥ã€‚</p><h4 id="tcmalloc" tabindex="-1"><a class="header-anchor" href="#tcmalloc" aria-hidden="true">#</a> tcmalloc</h4><p>å¦‚ä½•å®ç°æ›´å¥½çš„å†…å­˜ç®¡ç†æ–¹å¼å‘¢ï¼Ÿæ€è·¯å¾ˆç®€å•ï¼Œå€Ÿé‰´[æŠ„]ã€‚</p><p>å‰é¢åœ¨<a href="###%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%8E%9F%E7%90%86">å†…å­˜åˆ†é…åŸç†</a>ä¸­ï¼Œæˆ‘ä»¬æåˆ° malloc/free æœ‰å¤šç§ä¼˜ç§€çš„å†…å­˜ç®¡ç†å®ç°ï¼Œæ¯”å¦‚ <a href="https://github.com/google/tcmalloc/blob/master/docs/design.md" target="_blank" rel="noopener noreferrer">tcmalloc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å°±æ˜¯ Google å¼€æºçš„ä¸€æ¬¾å†…å­˜åˆ†é…å™¨ã€‚tcmalloc å…¨ç¨‹ thread cache mallocï¼Œå³æ ¸å¿ƒæ€æƒ³å°±åœ¨äºçº¿ç¨‹ç¼“å­˜ï¼Œå½“ç„¶ tcmalloc ä¼˜ç§€çš„è®¾è®¡ä¸æ­¢è¿™ä¸€ç‚¹ï¼Œä¸»è¦å¦‚ä¸‹ï¼š</p><ol><li>tcmalloc å¯¹å†…å­˜ä»¥<strong>é¡µ</strong>ä¸ºåŸºæœ¬å•ä½ï¼Œæ¯ä¸ªå‘è¿›ç¨‹ç”³è¯·å†…å­˜æ—¶ï¼Œè‡³å°‘ç”³è¯· 1 é¡µå†…å­˜ï¼›</li><li>tcmalloc å°ã€å¤§å¯¹è±¡å†…å­˜åˆ†é…ç­–ç•¥ä¸åŒï¼Œå°å†…å­˜çš„å—å¤§å°å›ºå®šï¼Œå¦‚ 8 å­—èŠ‚ã€16 å­—èŠ‚ã€32 å­—èŠ‚ç­‰ï¼Œæ¯ä¸ªé¡µéƒ½è£…æ»¡äº†ç›¸åŒå°ºå¯¸çš„å—ï¼Œå½“è°ƒç”¨ Malloc æ—¶ï¼Œä¼šæŒ‰ç…§å‚æ•°è®¡ç®—åˆé€‚çš„å—å¤§å°ï¼Œç„¶åå»é¡µä¸­æ‹¿åˆ°ç©ºé—´å—è¿”å›ï¼›å¯¹äºå¤§å†…å­˜ï¼Œå°±æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„å—ï¼Œè€Œæ˜¯ç›´æ¥æŒ‰ç…§é¡µæ¥åˆ†é…ï¼›</li><li>tcmalloc é€‚åˆå¤šçº¿ç¨‹ä¸‹çš„å†…å­˜åˆ†é…åœºæ™¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€å®šé‡çš„å†…å­˜ç¼“å­˜ï¼Œå½“ç”³è¯·è¿™äº›å†…å­˜æ—¶ï¼Œæ— éœ€åŠ é”ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ç¼“å­˜æ‹¿åˆ°ï¼Œè¿™æ ·å‡å°‘äº†æ•°æ®ç«äº‰ï¼Œæå‡äº†åˆ†é…æ€§èƒ½ï¼›</li></ol><p>tcmalloc çš„æ¶æ„æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç¬”è€…ä¼šç®€å•ä»‹ç»å®ƒçš„æ ¸å¿ƒæ¦‚å¿µä»¥åŠå®ç°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å¼€<a href="https://www.cnblogs.com/jiujuan/p/13869547.html" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ…¢æ…¢äº†è§£ã€‚</p><p>tcmalloc å¯¹å†…å­˜å—è¿›è¡Œäº†åˆ†ç±»(class)ï¼ŒåŒä¸€ä¸ª class çš„å—å†…å­˜å¤§å°æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·å°±ä¸ç”¨åœ¨ header ä¸­è®°å½•æ¯ä¸ªå—çš„å¤§å°äº†ï¼Œå¦å¤– tcmalloc é€šè¿‡ freelist(ç©ºé—²é“¾è¡¨) çš„æ–¹å¼æ¥è¿æ¥å†…å­˜å—ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/assets/tcmallocclass-8a9f9cae.png" alt="tcmallocclass"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œå¯¹äº class0ï¼Œå…¶å¤§å° 8 å­—èŠ‚ï¼Œé‚£ä¹ˆå®ƒæ‰€å¯¹åº”çš„ freelist ä¸­çš„æ¯ä¸€ä¸ªå†…å­˜å—éƒ½æ˜¯ 8 å­—èŠ‚ï¼›freelist æœ¬èº«æ˜¯ä¸€ä¸ªé¡µï¼Œè¢«ç»„ç»‡ä¸ºä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå½“å†…å­˜åˆ†é…æ—¶ï¼Œä» freelist ä¸­æ‹¿å‡º(pop)ä¸€ä¸ªå—è¿”å›ï¼Œå—æ— éœ€å†ä¸å…¶å®ƒå—é“¾æ¥ï¼Œå› æ­¤æ•´ä¸ªå—éƒ½æ˜¯å¯ç”¨å†…å­˜ï¼Œæ²¡æœ‰å…ƒæ•°æ®æµªè´¹ã€‚</p><p>ä½†æ˜¯è¿™ä¹Ÿä¼šå¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼Œè°ƒç”¨ Free çš„æ—¶å€™ï¼Œå—åˆè¯¥æ”¾å›é‚£ä¸ª freelist å‘¢ï¼Ÿ</p><p>tcmalloc å®šä¹‰æ¯ä¸ªé¡µéƒ½æœ‰ä¸€ä¸ª IDï¼Œè¿™ä¸ª ID ä¸æ˜¯ tcmalloc ç›´æ¥åˆ†é…çš„ï¼Œè€Œæ˜¯æŒ‰ç…§é¡µçš„é¦–åœ°å€ç®—å‡ºæ¥çš„ï¼Œå› æ­¤å°±æ¯ä¸ªå—çš„é¦–åœ°å€é™¤ä»¥é¡µå¤§å°å°±èƒ½å¾—åˆ°å¯¹åº”çš„é¡µ IDï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>pageNum <span class="token operator">:=</span> p <span class="token operator">/</span> pageSize
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™æ ·å°±èƒ½æ‹¿åˆ°å¯¹åº”çš„é¡µï¼Œä¹Ÿèƒ½æ‰¾åˆ°å¯¹åº”çš„ freelistã€‚</p><p>å†…å­˜åˆ†é…çš„åœºæ™¯ååˆ†å¤æ‚ï¼Œå¦‚æœæŸä¸ª class çš„å†…å­˜å—è¢«å¤§é‡ç”³è¯·ï¼Œä¸€ä¸ªé¡µå¾ˆå¿«å°±ä¼šè¢«ç”¨å®Œï¼Œå› æ­¤ tcmalloc å¼•å…¥äº† span è¿™ä¸ªæ¦‚å¿µã€‚</p><p>span ç”±ä¸€ä¸ªæˆ–å¤šä¸ªé¡µç»„æˆï¼Œè€Œä¸”è¿™äº›é¡µæ˜¯è¿ç»­çš„ï¼Œä¸”è¿™äº›é¡µçš„ class æ˜¯ä¸€æ ·å¤§çš„ï¼Œspan ä¹Ÿä¼šæœ‰ä¸€ä¸ªå›ºå®šçš„ class å¤§å°ï¼Œå¦‚ä¸‹ï¼š</p><img alt="tcmallocspan" src="/assets/tcmallocspan-50904e2e.png" width="100%" height="20%"><p>æœ€åå›åˆ° tcmalloc æœ€é‡è¦çš„ä¸€ç¯ä¸Šæ¥ï¼Œé‚£å°±æ˜¯ç¼“å­˜(cache)ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆå»ç¼“å­˜(cache)ä¸­å»æ‹¿ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰çš„è¯ï¼Œæ‰å»è¯·æ±‚å…¨å±€å†…å­˜(central)ã€‚central ç®¡ç†ç€å…¨å±€å†…å­˜ï¼Œç”±å®ƒè´Ÿè´£å‘è¿›ç¨‹ç”³è¯·å†…å­˜ï¼Œç„¶åå°†å†…å­˜æ‹¿åˆ°åæ”¾å…¥ PageHeap å’Œ PageMap ä¸­ç®¡ç†ï¼Œè¿™é‡Œåˆå¼•å…¥äº†ä¸¤ä¸ªæ–°çš„æ¦‚å¿µï¼š</p><ul><li>PageHeapï¼šé¡µå †ï¼Œå­˜å‚¨ central æ‰€ç”³è¯·çš„é¡µå†…å­˜ï¼›</li><li>PageMapï¼šé¡µè¡¨ï¼Œå­˜å‚¨é¡µ ID ä¸ span ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</li></ul><p>å½“ cache å‘ central ç”³è¯·å†…å­˜æ—¶ï¼Œcentral ä¼šä¼˜å…ˆä»é¡µå †ä¸­æ‹¿å‡ºç©ºé—²é¡µè¿”å›ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²é¡µå†å‘è¿›ç¨‹ç”³è¯·ï¼›å½“å†…å­˜å—é‡Šæ”¾æ—¶ï¼Œæ‹¿åˆ°é¡µ ID åï¼Œé€šè¿‡ PageMap æŸ¥è¯¢åˆ°å¯¹åº”çš„ span åï¼Œå°†å†…å­˜å—æ”¾å› spanï¼Œè¿™æ · Free çš„å·¥ä½œå°±å®Œæˆäº†ã€‚</p><p>centralã€cacheã€PageMapã€PageHeap çš„å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/assets/centralcache-bf6de2f2.png" alt="centralcache"></p><p>ä»‹ç»å®Œ tcmalloc çš„æ ¸å¿ƒæ¦‚å¿µå’ŒåŸç†åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•ç”¨ Go å®ç° tcmallocã€‚è¿™é‡Œè¯´æ˜ï¼Œç”±äºåœ¨ Go ä¸­æ²¡æœ‰æä¾›çº¿ç¨‹ç¼“å­˜çš„ APIï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨çº¿ç¨‹ç¼“å­˜ï¼Œæ‰€ä»¥å®ç°ä¸­å®šä¹‰çš„ Cache ä»…ä»…åªèƒ½æ¨¡æ‹Ÿå‡º Cache çš„æœºåˆ¶ï¼Œè€Œæ— æ³•å‘æŒ¥çº¿ç¨‹ç¼“å­˜çš„ä½œç”¨ã€‚</p><p>å¯¹äºå†…å­˜å¼€è¾Ÿ(Malloc)ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Malloc åˆ†é…å†…å­˜</span>
<span class="token keyword">func</span> <span class="token function">Malloc</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">uintptr</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> size <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// å°å¯¹è±¡</span>
	<span class="token keyword">if</span> size <span class="token operator">&lt;=</span> smallObjectSize <span class="token punctuation">{</span>
		<span class="token comment">// è®¡ç®— size å¯¹åº”çš„ class</span>
		class <span class="token operator">:=</span> <span class="token function">size2Class</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
		obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> threadCache<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>class<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;malloc err: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> obj <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// å¤§å¯¹è±¡</span>
	numPages <span class="token operator">:=</span> <span class="token punctuation">(</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>pageSize <span class="token operator">+</span> <span class="token number">1</span>
	globalLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> globalLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	s<span class="token punctuation">,</span> err <span class="token operator">:=</span> globalPageHeap<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span>numPages<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;malloc err: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	s<span class="token punctuation">.</span>state <span class="token operator">=</span> allocatedLarge
	<span class="token keyword">return</span> s<span class="token punctuation">.</span>pageStart
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å’Œåˆšæ‰è°ˆåˆ°çš„ä¸€æ ·ï¼Œå¯¹è±¡åˆ†é…æœ‰ä¸¤ç§æƒ…å†µï¼›å¯¹äºå°å†…å­˜ï¼Œè®¡ç®—å‡ºå¯¹åº”çš„ class åç›´æ¥å»çº¿ç¨‹ç¼“å­˜ threadCache ä¸­å»æ‹¿å³å¯ï¼Œå¯¹äºå¤§å†…å­˜ï¼Œåˆ™æ˜¯ç›´æ¥è®¡ç®—å‡ºé¡µä¸ªæ•°å»å…¨å±€çš„ PageHeap ä¸­æ‹¿åˆ°å†…å­˜ã€‚</p><p>è¿™é‡Œéº»çƒ¦çš„æ˜¯ <code>threadCache.getObject(class)</code> å‡½æ•°ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ˜¯ä¸€æ¡å¾ˆé•¿çš„é“¾è·¯ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/assets/getObjects-b1a44b8f.png" alt="getObjects"></p><p>é¦–å…ˆï¼Œcache ä¼šå…ˆåˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦æœ‰å¯ç”¨çš„å—å†…å­˜ï¼Œå¦‚æœ‰ç›´æ¥è¿”å›ï¼›è‹¥æ²¡æœ‰ï¼Œåˆ™éœ€å‘ central ç”³è¯·ï¼Œè‹¥ central æœ‰åˆ™è¿”å›ï¼Œå¦åˆ™è¿˜éœ€å‘è¿›ç¨‹ç”³è¯·ï¼Œç„¶åè¿”å›ã€‚</p><p>å¯¹äºå†…å­˜é‡Šæ”¾(Free)ï¼Œè¿‡ç¨‹ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œå®ç°å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Free é‡Šæ”¾å†…å­˜</span>
<span class="token keyword">func</span> <span class="token function">Free</span><span class="token punctuation">(</span>p <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// å…ˆè·å–å¯¹åº”çš„ span</span>
	pageNum <span class="token operator">:=</span> p <span class="token operator">/</span> pageSize
	addr <span class="token operator">:=</span> globalPageMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> addr <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	s <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>span<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// æ— éœ€å†æ¬¡é‡Šæ”¾</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>state <span class="token operator">==</span> free <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// å°å¯¹è±¡ï¼Œå›æ”¶è‡³ç¼“å­˜</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>state <span class="token operator">==</span> allocatedSmall <span class="token punctuation">{</span>
		threadCache<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>objectClass<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>object<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// å¤§å¯¹è±¡ç›´æ¥æ”¾å› pageHeap</span>
	globalLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> globalLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	s<span class="token punctuation">.</span><span class="token function">coalesce</span><span class="token punctuation">(</span>globalPageHeap<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> globalPageHeap<span class="token punctuation">.</span><span class="token function">insertSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;free err: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†é¿å…äºŒæ¬¡é‡Šæ”¾ï¼Œæ‰€ä»¥ä¼šå…ˆåˆ¤æ–­å¯¹åº” span çš„çŠ¶æ€ï¼›å¦‚æœæ˜¯å°å¯¹è±¡ï¼Œç›´æ¥æ’å…¥å› cache ä¸­ï¼Œæ–¹ä¾¿ä¸‹æ¬¡åˆ†é…ï¼›å¯¹äºå¤§å¯¹è±¡ï¼Œå‰é¢è¯´åˆ°å¤§å¯¹è±¡æ˜¯æŒ‰é¡µæ¥åˆ†é…çš„ï¼Œå› æ­¤æ˜¯æ— æ³•æ’å…¥ä¼š cache çš„ï¼Œåªèƒ½å°†å…¶é‡æ–°æ’å…¥ PageHeapã€‚</p><p>ç”±äº tcmalloc çš„å®ç°ç»†èŠ‚è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š</p><ul><li>é¡µä¹‹é—´çš„åˆ†è£‚ä¸åˆå¹¶ï¼›</li><li>span ä¹‹é—´å¦‚ä½•é“¾æ¥ï¼›</li><li>PageMap å¦‚ä½•å­˜å‚¨é¡µ ID å’Œ span ä¹‹é—´çš„æ˜ å°„ï¼›</li></ul><p>è¿™äº›å†…å®¹æ¯”è¾ƒå¤šï¼Œæ”¾åœ¨è¿™é‡Œä¸€ä¸€ç»†è®²ä¼šæµªè´¹å¾ˆå¤§çš„ç¯‡å¹…ï¼Œå› æ­¤è¿™é‡Œé€‰æ‹©ç•¥è¿‡ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥çœ‹<a href="">æºç </a>ã€‚å½“ç„¶ç¬”è€…çš„å®ç°ç•¥æ˜¾ç²—ç³™ï¼Œæš‚æ—¶æ— æ³•åº”ç”¨åœ¨å®é™…åœºæ™¯ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥é˜…è¯» tcmalloc çš„<a href="https://github.com/google/tcmalloc" target="_blank" rel="noopener noreferrer">æºç <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ tcmallocï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestFree4</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	assert <span class="token operator">:=</span> assert<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>

	pointers <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		p1 <span class="token operator">:=</span> <span class="token function">Malloc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
		assert<span class="token punctuation">.</span><span class="token function">NotEqual</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>
		pointers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pointers<span class="token punctuation">,</span> p1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">Free</span><span class="token punctuation">(</span>pointers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ" aria-hidden="true">#</a> è‡ªåŠ¨å†…å­˜ç®¡ç†å®è·µ</h3><p>ç°åœ¨ï¼Œæ‰‹åŠ¨å†…å­˜ç®¡ç†å°†å‘Šä¸€æ®µè½äº†ï¼Œä¸‹é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†è°ˆè°ˆå¦‚ä½•å®ç°è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è°ˆåˆ°çš„ <a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)" target="_blank" rel="noopener noreferrer">GC<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> å®ç°ã€‚</p><p>ä¹‹æ‰€ä»¥åœ¨è‡ªåŠ¨å†…å­˜ç®¡ç†æ”¾åœ¨æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„åé¢ï¼Œé‚£æ˜¯å› ä¸ºè‡ªåŠ¨å†…å­˜ç®¡ç†ä¾èµ–äºæ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œå°±æ¯”å¦‚ Java çš„ GC å®é™…è¿˜æ˜¯ä¾é  malloc/free æ¥å®ç°çš„ï¼Œåªä¸è¿‡è¿™äº›ç”± GC ç®—æ³•æ¥è‡ªåŠ¨è°ƒç”¨ï¼Œè§£æ”¾äº†æˆ‘ä»¬çš„åŒæ‰‹ã€‚</p><p>æˆ‘ä»¬åˆšæ‰å®ç°äº†ä¸¤ä¸ªç‰ˆæœ¬çš„ malloc/freeï¼Œå·²ç»å¯¹å†…å­˜ç®¡ç†æœ‰äº†ä¸€å®šçš„è®¤è¯†ä¸ç†è§£ï¼Œå¯¹è¿™ç§æœºæ¢°å¼çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦æ”¹é€ å®ƒã€‚</p><blockquote><p>æä¸€ä¸‹ï¼šå®é™…ä¸Š Go æœ¬æ¥å°±æœ‰ GCï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å†è°ˆ GC å®ç°äº†ï¼Ÿä¸»è¦æ˜¯ç¬”è€…ä¸€ç›´è§‰å¾— GC è™½ç„¶å¥½ï¼Œä½†æ˜¯éšè—äº†å¤ªå¤šçš„å†…å­˜ç»†èŠ‚ï¼Œè€Œè¿™äº›ç»†èŠ‚æœ‰æ—¶å€™åˆå¾ˆé‡è¦ï¼Œå› æ­¤æ‰å†™ä¸‹è¿™ç¯‡æ–‡ç« æ¥é¾™å»è„‰çš„æ¥è°ˆè°ˆå†…å­˜ç®¡ç†ã€‚</p></blockquote><p>åœ¨å‰é¢çš„<a href="###%E8%87%AA%E5%8A%A8%E7%AE%A1%E7%90%86">è‡ªåŠ¨ç®¡ç†</a>å¤„ï¼Œç¬”è€…æ›¾è¯´è¿‡ï¼ŒLisp æ˜¯ç¬¬ä¸€ä¸ªç”¨ä¸Š GC çš„è¯­è¨€ï¼Œä¸”å…¶ç®—æ³•æ˜¯æ ‡è®°æ¸…ç†ç®—æ³•(Mark-sweep)ã€‚Mark-sweep æ˜“æ‡‚ï¼Œè€Œä¸”ååˆ†çš„ç»å…¸ï¼Œè™½ç„¶ç›®å‰æœ‰å¾ˆå¤šçš„ GC ç®—æ³•å®ç°ï¼Œä½†æˆ–å¤šæˆ–å°‘ä¿ç•™ç€å®ƒçš„å½±å­ï¼ŒåŒ…æ‹¬ Go çš„ GC ç®—æ³•â€”â€”ä¸‰è‰²æ ‡è®°æ³•ã€‚</p><h4 id="mark-sweep-æ ‡è®°æ¸…ç†æ³•" tabindex="-1"><a class="header-anchor" href="#mark-sweep-æ ‡è®°æ¸…ç†æ³•" aria-hidden="true">#</a> Mark Sweep(æ ‡è®°æ¸…ç†æ³•)</h4><p>å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥è°ˆè°ˆ Mark-sweep ç®—æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆå¼•å…¥å‡ ä¸ªæ¦‚å¿µã€‚</p><p>ä¸€ã€å¯è¾¾æ€§</p><p>ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„åƒåœ¾å¯¹è±¡ï¼ŒGC ç®—æ³•éœ€è¦æ‰¾åˆ°è¿™äº›åƒåœ¾å¯¹è±¡ç„¶åæ‰èƒ½æ¸…ç†ã€‚é‚£ä¹ˆå¦‚ä½•å®šä¹‰å¯¹è±¡æ˜¯å¦ä¸ºåƒåœ¾å‘¢ï¼Ÿå¤§å¤šæ•° GC å®ç°éƒ½é‡‡ç”¨å¯è¾¾æ€§åˆ†ææ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå­˜æ´»åˆ™ä¿ç•™ï¼Œéå­˜æ´»åˆ™å½“æˆåƒåœ¾å›æ”¶ã€‚</p><p>äºŒã€GC roots</p><p>å¦‚æœå°†ç¨‹åºå¯¹è±¡è§†ä¸ºä¸€ä¸ªç½‘çŠ¶å›¾ï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è¾¾å®é™…å°±æ˜¯åœ¨å›¾ä¸­æœç´¢å‡ºè·¯å¾„ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œè€Œå›¾çš„æœç´¢éœ€è¦ä¸€ä¸ªèµ·ç‚¹ï¼Œè¿™ä¸ªèµ·ç‚¹å°±è¢«ç§°ä½œ GC rootsã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ªç®€å•ç¨‹åºçš„å¯¹è±¡åˆ†å¸ƒå›¾ï¼š</p><img alt="å¯è¾¾æ€§" src="/assets/å¯è¾¾æ€§-10ecd785.png" width="50%" height="50%" style="margin:0 auto;"><p>å›¾ä¸­åº•éƒ¨çš„è±å½¢å›¾æ ‡å°±æ˜¯ GC rootsï¼Œä» GC roots å‡ºå‘ï¼Œéå†å¯¹è±¡å›¾ï¼Œçº¢è‰²åœ†åœˆè¡¨ç¤ºå¯è¾¾ï¼Œç™½è‰²åœ†åœˆä¸ºä¸å¯è¾¾ã€‚</p><p>GC roots ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç±»å¯¹è±¡ï¼š</p><ul><li>å¯„å­˜å™¨å˜é‡ï¼›</li><li>å±€éƒ¨å˜é‡ï¼›</li><li>å…¨å±€å˜é‡ï¼›</li><li>ã€‚ã€‚ã€‚</li></ul><p>å½“ Mark-sweep å¼€å§‹å·¥ä½œæ—¶ï¼Œä»æ‰€æœ‰ GC roots å‡ºå‘ï¼Œæ²¿ç€è¿æ¥æœç´¢å›¾ä¸­å¯¹è±¡ï¼Œå°†å¯è¾¾é˜Ÿå¯¹è±¡ä¾æ¬¡æ ‡è®°ï¼ˆMark é˜¶æ®µï¼‰ï¼Œæ ‡è®°å®Œæˆåï¼Œå°†æ‰€æœ‰ä¸å¯è¾¾çš„å¯¹è±¡å…¨éƒ¨æ¸…ç†æ‰ï¼ˆSweep é˜¶æ®µï¼‰ã€‚å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/marksweep-2a17308e.png" alt="marksweep"></p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å®ç° Mark-sweep ç®—æ³•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰é€šç”¨å¯¹è±¡ç»“æ„ä½“ <code>Object</code>ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// ObjectType å¯¹è±¡ç±»å‹</span>
<span class="token keyword">type</span> ObjectType <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// ObjInt int å¯¹è±¡</span>
	ObjInt ObjectType <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token comment">// ObjPair å…ƒç»„å¯¹è±¡</span>
	ObjPair
<span class="token punctuation">)</span>

<span class="token comment">// Object å¯¹è±¡</span>
<span class="token keyword">type</span> Object <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	typ    ObjectType  <span class="token comment">// 8</span>
	next   <span class="token operator">*</span>Object     <span class="token comment">// 8</span>
	marked <span class="token builtin">bool</span>        <span class="token comment">// 8</span>
	inner  <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 16</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Object ç”¨äºè¡¨ç¤ºä»»æ„å¯¹è±¡ï¼Œå¦‚ integer å¯¹è±¡ï¼Œæˆ–è€… pair å¯¹è±¡ï¼›å®ƒæœ‰ 4 ä¸ªå­—æ®µï¼š</p><ul><li>typï¼šå¯¹è±¡ç±»å‹ï¼›</li><li>nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€æœ‰å¯¹è±¡ç”±é“¾è¡¨è¿æ¥ï¼›</li><li>markedï¼šæ ‡è®°å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼›</li><li>innerï¼šçœŸæ­£çš„æ•°æ®ï¼Œå¦‚ï¼šinteger å¯¹è±¡ï¼Œinner å¯èƒ½ä¸º 998ã€‚</li></ul><p>è¿™æ ·æ¯ä¸ªæ–°å»ºçš„å¯¹è±¡éƒ½æœ‰ç±»å‹ã€æ ‡è®°ã€è¿æ¥ç­‰å…ƒæ•°æ®ä¿¡æ¯ï¼Œnext æŒ‡é’ˆä¼šå°†æ‰€æœ‰å¯¹è±¡è¿æ¥æˆä¸€ä¸ªå¤§é“¾è¡¨ï¼Œæ–¹ä¾¿åœ¨æ¸…ç†é˜¶æ®µæ‰¾åˆ°ä¸å¯è¾¾(mark ä¸º false)å¯¹è±¡ï¼Œç„¶åå°†å…¶æ¸…ç†æ‰ã€‚</p><blockquote><p>æä¸€ç‚¹ï¼šåœ¨ GC é˜¶æ®µï¼Œå¯¹è±¡å›¾ä¹‹é—´çš„è¿æ¥ä¸æ˜¯ next æŒ‡é’ˆï¼Œè€Œæ˜¯å¯¹è±¡ä¹‹é—´çš„ç›¸äº’å¼•ç”¨ï¼Œnext æŒ‡é’ˆæ˜¯ä¸ºäº†è·Ÿè¸ªæ‰€æœ‰çš„å¯¹è±¡ã€‚</p></blockquote><p>åŒæ—¶ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>VM</code> ç»“æ„ä½“ç”¨äºå¯¹è±¡åˆ†é…ã€GC ç­‰ï¼ŒVMï¼ˆè™šæ‹Ÿæœºï¼‰æ˜¯å®ç° GC æœ€é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒä¸»è¦ç”±å¦‚ä¸‹åŠŸèƒ½ç‚¹ï¼š</p><ul><li>è´Ÿè´£æ–°å»ºå¯¹è±¡ã€ç»´æŠ¤å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼›</li><li>è´Ÿè´£ç®¡ç†æ‰€æœ‰å¯¹è±¡ï¼Œç»´æŠ¤å¯¹è±¡ä¸ªæ•°ç­‰ä¿¡æ¯ï¼›</li><li>è´Ÿè´£å®æ—¶ç›‘æ§å¯¹è±¡æ•°æ®ä¿¡æ¯ï¼Œåœ¨åˆé€‚çš„æ—¶é—´è§¦å‘ GCã€‚</li></ul><p>å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> VM <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	numObjects <span class="token builtin">int</span>        <span class="token comment">// å½“å‰å¯¹è±¡ä¸ªæ•°</span>
	maxObjects <span class="token builtin">int</span>        <span class="token comment">// æœ€å¤§å¯¹è±¡ä¸ªæ•°ï¼Œè¶…è¿‡è¿™ä¸ªå€¼åˆ™è§¦å‘GC</span>
	link       <span class="token operator">*</span>Object    <span class="token comment">// å¯¹è±¡é“¾è¡¨ï¼Œæ‰€æœ‰åˆ†é…å¯¹è±¡é€šè¿‡é“¾è¡¨è¿æ¥</span>
	stack      <span class="token punctuation">[</span>stackMax<span class="token punctuation">]</span><span class="token operator">*</span>Object <span class="token comment">// æ ˆï¼Œç”¨æ ˆæ¥æ¨¡æ‹Ÿ GC roots</span>
	stackSize  <span class="token builtin">int</span>  <span class="token comment">// å½“å‰æ ˆå¤§å°</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å­—æ®µè¯´æ˜éƒ½å·²æ³¨æ˜ï¼Œè¿™é‡Œä»éœ€ç®€å•è¯´ä¸€ä¸‹ï¼š</p><ul><li>GC roots çš„èŒƒå›´æ˜¯æ¯”è¾ƒå¹¿çš„ï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰é‡æ–°å®ç°ä¸€é—¨è¯­è¨€ï¼Œå› æ­¤å¯„å­˜å™¨ã€å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡è¿™äº›æ•°æ®æ˜¯è¿½è¸ªä¸åˆ°çš„ï¼Œå› æ­¤è¿™é‡Œé€‰æ‹©ä½¿ç”¨æ ˆæ¥æ¨¡æ‹Ÿ GC rootsï¼Œå³åœ¨æ ˆä¸Šçš„å˜é‡éƒ½æ˜¯ GC rootsï¼›å®é™…ä¸Šå¾ˆå¤šå¸¦è™šæ‹Ÿæœºçš„è¯­è¨€å®ç°åŸºæœ¬ä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼›</li><li>å¯¹äº GC çš„è§¦å‘æœºåˆ¶ï¼Œè¿™é‡Œé€‰æ‹©æœ€ç®€å•çš„æ•°é‡é˜ˆå€¼è§¦å‘ï¼Œå½“å¯¹è±¡ä¸ªæ•°è¶…è¿‡äº†é˜ˆå€¼ï¼Œåˆ™è§¦å‘ï¼›</li></ul><p>å¦å¤–ç”±äº linkã€next æŒ‡é’ˆæ˜¯ä¸ºäº†å°†æ‰€æœ‰å¯¹è±¡è¿æ¥èµ·æ¥ï¼Œå› æ­¤å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œå³å¯¹è±¡å›¾ä¸­çš„è·¯å¾„è¿æ¥ï¼Œå°±éœ€è¦æ–°çš„æœºåˆ¶æ¥æ¨¡æ‹Ÿï¼Œè¿™é‡Œæˆ‘ä»¬å¼•å…¥äº†å…ƒç¥–(Pair)ç±»å‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Pair <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	head <span class="token operator">*</span>Object <span class="token comment">// å¤´</span>
	tail <span class="token operator">*</span>Object <span class="token comment">// å°¾</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ Pair å¯¹è±¡ä¸­çš„å¤´ã€å°¾æŒ‡é’ˆæ¥æ¨¡æ‹Ÿå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ï¼ŒPair æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸€ä¸ª pair å¯¹è±¡ä¼šå¼•ç”¨å¦å¤–ä¸¤ä¸ªå¯¹è±¡ã€‚</p><p>æ–°å»ºå¯¹è±¡éƒ½å¿…é¡»é€šè¿‡ VM æ¥æ“ä½œï¼ŒVM å‘ tcmalloc ç”³è¯·å†…å­˜åï¼Œå°†å…¶åŠ å…¥åˆ°å…¨å±€é“¾è¡¨å¹¶å…¥æ ˆï¼Œè¿™æ ·å¯¹è±¡ä¸ä»…å¯ä»¥é€šè¿‡é“¾è¡¨è¢«æ‰¾åˆ°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ GC rootsã€‚å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å¯¹è±¡å…¥æ ˆï¼ŒåŠ å…¥ GC roots</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">push</span><span class="token punctuation">(</span>value <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>stackSize<span class="token punctuation">]</span> <span class="token operator">=</span> value
	v<span class="token punctuation">.</span>stackSize<span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ•´æ•°å¯¹è±¡å…¥æ ˆ</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">pushInt</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	obj <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>ObjInt<span class="token punctuation">)</span>
	obj<span class="token punctuation">.</span>inner <span class="token operator">=</span> n
	v<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ–°å»ºå¯¹è±¡ï¼Œè°ƒç”¨ tcmallocï¼Œå¹¶åŠ å…¥å…¨å±€é“¾è¡¨ï¼Œç„¶åè¿”å›</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">newObject</span><span class="token punctuation">(</span>typ ObjectType<span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span>numObjects <span class="token operator">==</span> v<span class="token punctuation">.</span>maxObjects <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> tcmalloc<span class="token punctuation">.</span><span class="token function">Malloc</span><span class="token punctuation">(</span>objSiz<span class="token punctuation">)</span>
	obj <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>Object<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
	obj<span class="token punctuation">.</span>typ <span class="token operator">=</span> typ
	obj<span class="token punctuation">.</span>next <span class="token operator">=</span> v<span class="token punctuation">.</span>link
	obj<span class="token punctuation">.</span>marked <span class="token operator">=</span> <span class="token boolean">false</span>
	v<span class="token punctuation">.</span>link <span class="token operator">=</span> obj
	v<span class="token punctuation">.</span>numObjects<span class="token operator">++</span>
	<span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼ŒVM åˆ†åˆ«ä¸º intã€pair ç±»å‹æä¾›å¯¹åº”çš„æ–°å»ºã€å…¥æ ˆ APIï¼›å¯¹äº int ç±»å‹ï¼Œåˆ†é…å†…å­˜ã€åŠ å…¥å…¨å±€é“¾è¡¨åå³å¯å…¥æ ˆï¼Œè€Œ pair å¯¹è±¡åˆ™ç›¸å¯¹éº»çƒ¦ä¸€ç‚¹ï¼Œéœ€è¦ä»æ ˆé¡¶å¼¹å‡ºä¸¤ä¸ªå¯¹è±¡ç„¶åå†å…¥æ ˆï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å…ƒç»„å¯¹è±¡å…¥æ ˆï¼Œå…ˆä»æ ˆä¸­popå‡ºä¸¤ä¸ªå¯¹è±¡ï¼Œå»ºç«‹å…³è”åå†å…¥æ ˆ</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">pushPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span>
	obj <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>ObjPair<span class="token punctuation">)</span>
	addr <span class="token operator">:=</span> tcmalloc<span class="token punctuation">.</span><span class="token function">Malloc</span><span class="token punctuation">(</span>pairSiz<span class="token punctuation">)</span>
	pair <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>Pair<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
	pair<span class="token punctuation">.</span>head <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pair<span class="token punctuation">.</span>tail <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	obj<span class="token punctuation">.</span>inner <span class="token operator">=</span> pair
	v<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å°±å­˜åœ¨å¼•ç”¨å…³ç³»ï¼Œå³ä½¿äºŒè€…ä¸åœ¨æ ˆä¸­ï¼Œä»å¯é€šè¿‡å›¾æ‰«æè¢«æ‰¾åˆ°ã€‚è€Œé‚£äº›æ—¢ä¸åœ¨æ ˆä¸­ï¼Œä¹Ÿæ²¡æ³•é€šè¿‡æ‰«ææ‰¾åˆ°çš„å¯¹è±¡ï¼Œè‡ªç„¶å°±æ˜¯åƒåœ¾å¯¹è±¡ï¼Œå®ƒä»¬å°†ä¼šè¢«å›æ”¶ã€‚å› æ­¤ï¼ŒVM æä¾›äº† pop æ¥è®©ä¸€ä¸ªå¯¹è±¡å‡ºæ ˆï¼Œä»è€Œå°±ä¸å†æ˜¯ GC roots äº†ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// æ ˆé¡¶å¯¹è±¡å‡ºæ ˆï¼Œä¸å†æ˜¯ GC roots</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span>
	v<span class="token punctuation">.</span>stackSize<span class="token operator">--</span>
	<span class="token keyword">return</span> v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>stackSize<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢åˆ™æ˜¯ mark-sweep ç®—æ³•çš„å…·ä½“å®ç°äº†ï¼Œåœ¨æ ‡è®°é˜¶æ®µï¼Œä»æ¯ä¸ª GC roots å¼€å§‹ï¼Œæ ‡è®°å®ƒä»¬æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// æ ‡è®°æ‰€æœ‰ GC roots åŠå¯è¾¾å¯¹è±¡</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">markAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token punctuation">.</span>stackSize<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ ‡è®°å¯¹è±¡</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>marked <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>marked <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>typ <span class="token operator">==</span> ObjPair <span class="token punctuation">{</span>
		p <span class="token operator">:=</span> o<span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Pair<span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ˆä¸­æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ GC rootsï¼Œå¦‚æœæ˜¯ int å¯¹è±¡ï¼Œç›´æ¥è®¾ç½® mark ä¸º true å³å¯ï¼Œè€Œå¦‚æœæ˜¯ pair å¯¹è±¡åˆ™è¿˜éœ€æ ‡è®°å®ƒçš„ä¸¤ä¸ªå¤´ã€å°¾æŒ‡é’ˆï¼›å¤´ã€å°¾æŒ‡é’ˆè™½ç„¶ä¸åœ¨æ ˆä¸­ï¼Œä½†å®ƒä»¬æ˜¯ GC roots å¯è¾¾çš„ï¼Œæ ‡è®°å®Œæˆåï¼Œå‰©ä½™çš„å¯¹è±¡å°±æ˜¯ä¸å¯è¾¾çš„ï¼Œæˆ‘ä»¬è°ƒç”¨ sweep å°†å…¶æ¸…ç†æ‰ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// æ¸…ç†</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">sweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	obj <span class="token operator">:=</span> v<span class="token punctuation">.</span>link
	<span class="token keyword">for</span> obj <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>obj<span class="token punctuation">.</span>marked <span class="token punctuation">{</span>
			unreached <span class="token operator">:=</span> obj
			obj <span class="token operator">=</span> unreached<span class="token punctuation">.</span>next
			addr <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>unreached<span class="token punctuation">)</span><span class="token punctuation">)</span>
			tcmalloc<span class="token punctuation">.</span><span class="token function">Free</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
			v<span class="token punctuation">.</span>numObjects<span class="token operator">--</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			obj<span class="token punctuation">.</span>marked <span class="token operator">=</span> <span class="token boolean">false</span>
			obj <span class="token operator">=</span> obj<span class="token punctuation">.</span>next
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äºæ‰€æœ‰å¯¹è±¡éƒ½ä¼šè¿æ¥åœ¨å…¨å±€é“¾è¡¨ link ä¸Šï¼Œsweep ä» link çš„å¤´èŠ‚ç‚¹å¼€å§‹éå†ï¼Œå¦‚æœå¯¹è±¡æœªè¢«æ ‡è®°åˆ™è¡¨ç¤ºä¸å¯è¾¾ï¼Œå› æ­¤å°†å…¶ Free æ‰ï¼Œå¦‚æœå¯¹è±¡å¯è¾¾ï¼Œåˆ™è·³åˆ°ä¸‹ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼Œè¿™æ ·æ‰«æå®Œæ¯•åï¼Œåƒåœ¾ä¹Ÿä¼šè¢«æ¸…ç†å®Œæ¯•ã€‚</p><p>æœ€åï¼Œå°†æ ‡è®°ã€æ¸…ç†æ”¾åœ¨ä¸€èµ·ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	numObjects <span class="token operator">:=</span> v<span class="token punctuation">.</span>numObjects
	<span class="token keyword">if</span> numObjects <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// mark</span>
	v<span class="token punctuation">.</span><span class="token function">markAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// sweep</span>
	v<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span>numObjects <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span>maxObjects <span class="token operator">=</span> initialGCThreshold
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span>maxObjects <span class="token operator">*=</span> <span class="token number">2</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Collected %d objects, %d remaining.\n&quot;</span><span class="token punctuation">,</span>
		numObjects<span class="token operator">-</span>v<span class="token punctuation">.</span>numObjects<span class="token punctuation">,</span> v<span class="token punctuation">.</span>numObjects<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•çš„ mark-sweep ç®—æ³•å·²ç»å®ç°å®Œæ¯•ï¼Œå½“ç„¶ GC ä¸€èˆ¬éƒ½æ˜¯è¢«åŠ¨è§¦å‘çš„ï¼Œè¿™é‡Œé€‰æ‹©å°†è§¦å‘æ—¶æœºæ”¾åœ¨ newObject ä¸­ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">newObject</span><span class="token punctuation">(</span>typ ObjectType<span class="token punctuation">)</span> <span class="token operator">*</span>Object <span class="token punctuation">{</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span>numObjects <span class="token operator">==</span> v<span class="token punctuation">.</span>maxObjects <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ....</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç›®å‰å¯¹è±¡ä¸ªæ•°è¶…è¿‡äº†é˜ˆå€¼åï¼Œå°±ä¼šè§¦å‘ GCï¼Œè€Œä¸”é˜ˆå€¼ä¹Ÿä¼šéšç€è¿è¡Œæƒ…å†µè€Œæ”¹å˜(è§ GC å‡½æ•°)ã€‚</p><p>ç®€å•æµ‹è¯•ä¸€ä¸‹ mark-sweep ç®—æ³•ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestVM_GC4</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	assert <span class="token operator">:=</span> assert<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	vm <span class="token operator">:=</span> <span class="token function">NewVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	a <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">pushPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">pushPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// æ”¹å˜a,bçš„å¼•ç”¨ï¼Œä¸å†æŒ‡å‘ 2,4ï¼Œå› æ­¤2,4å°±å˜æˆäº†åƒåœ¾</span>
	a<span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Pair<span class="token punctuation">)</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> b
	b<span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Pair<span class="token punctuation">)</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> a
	<span class="token comment">// æ­¤æ—¶å·²åˆ†é… 6 ä¸ªå¯¹è±¡</span>
	assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>numObjects<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// GC</span>
	assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>numObjects<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 2,4 è¢«å›æ”¶äº†</span>
	vm<span class="token punctuation">.</span><span class="token function">Free</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œvm æ–°å»ºäº† 6 ä¸ªå¯¹è±¡ï¼Œä½†æ ˆä¸­åªæœ‰ 2 ä¸ª GC rootsï¼Œå…¶ä»– 4 ä¸ªåˆ™æ˜¯å¼•ç”¨å¯è¾¾ï¼Œæœ€åæ”¹å˜ aï¼Œb çš„å¼•ç”¨ï¼Œä¸å†å¼•ç”¨ 2ï¼Œ4ï¼Œå®ƒä»¬ä¹Ÿå°±æˆäº†åƒåœ¾ï¼Œå½“è°ƒç”¨ GC æ—¶ï¼Œä¼šè¢«å›æ”¶æ‰ï¼Œå¯¹è±¡å°±å‰© 4 ä¸ªäº†ã€‚</p><p>æ˜¾ç„¶ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†çš„æœ¬è´¨ä»æ˜¯ malloc/free ä¸¤ä¸ªå‡½æ•°ï¼Œåªæ˜¯å®ƒä»¬ä¸å†ç”±ç”¨æˆ·ä¸»åŠ¨è°ƒç”¨ï¼Œè€Œæ˜¯ç”± GC ç®—æ³•é€‰æ‹©åˆé€‚çš„æ—¶æœºæ¥è°ƒç”¨ã€‚</p><h4 id="tricolor-ä¸‰è‰²æ ‡è®°æ³•" tabindex="-1"><a class="header-anchor" href="#tricolor-ä¸‰è‰²æ ‡è®°æ³•" aria-hidden="true">#</a> tricolor(ä¸‰è‰²æ ‡è®°æ³•)</h4><p>mark-sweep ç®—æ³•ç®€å•æ˜“ç†è§£ï¼Œä½†å´æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼šmark å’Œ sweep è¿™ä¸¤ä¸ªé˜¶æ®µå¿…é¡»å…ˆåè¿›è¡Œï¼Œä¸”ä¸å¯è¢«æ‰“æ–­ï¼Œè€Œä¸”å¿…é¡» STWã€‚</p><p>å› æ­¤ï¼ŒSTW çš„æ—¶é—´è‚¯å®šæ¯”è¾ƒé•¿ï¼Œä¸€ä¸ªç¨‹åºé•¿æ—¶é—´æš‚åœæœåŠ¡è‚¯å®šæ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› æ­¤ mark-sweep æœ‰éå¸¸å¤šçš„æ”¹è¿›ç‰ˆæœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªéå¸¸è‘—åçš„æ”¹è¿›ç®—æ³•ï¼Œä¹Ÿæ˜¯ Go é‡‡ç”¨çš„ GC ç®—æ³•â€”â€”ä¸‰è‰²æ ‡è®°æ³•ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹ä¸‰è‰²æ ‡è®°æ³•(tricolor)ã€‚</p><p>ä¸‰è‰²æ ‡è®°æ³•æ˜¯æ ‡è®°æ¸…ç†æ³•çš„ä¸€ä¸ªæ”¹è¿›ç®—æ³•ï¼Œä¸»è¦ç›®çš„æ˜¯å°†æ ‡è®°é˜¶æ®µåˆ†å¼€æˆå¤šä¸ªå°é˜¶æ®µï¼Œæ¯ä¸ªå°é˜¶æ®µéƒ½å¯ä»¥å®Œæˆä¸€éƒ¨åˆ†æ ‡è®°å·¥ä½œï¼Œå¾…å…¨éƒ¨æ ‡è®°å®Œæˆåå†æ¥ä¸€æ¬¡æ¸…ç†ã€‚</p><p>ç”±äºæ ‡è®°é˜¶æ®µå ç”¨äº† GC çš„å¤§é‡æ—¶é—´ï¼Œè¿™æ ·å°±èƒ½æ˜¾è‘—åœ°é™ä½æ ‡è®° STW æ—¶é—´ã€‚</p><p>ä¸‰ä¸ªæ ‡è®°æ³•å°†å¯¹è±¡æŠ½è±¡ä¸º 3 ç§ä¸‰ç§é¢œè‰²ï¼š</p><ul><li>é»‘è‰²ï¼šå¯¹è±¡å·²ç»æ‰«æï¼Œä¸”å…¶å¼•ç”¨å¯¹è±¡ä¹Ÿå·²ç»æ‰«æ</li><li>ç°è‰²ï¼šå¯¹è±¡å·²ç»æ‰«æï¼Œä½†å…¶å¼•ç”¨å¯¹è±¡æœªè¢«æ‰«æ</li><li>ç™½è‰²ï¼šå¯¹è±¡æœªè¢«æ‰«æ</li></ul><p>é¢œè‰²æŠ½è±¡æ˜¯è¿™æ ·å°†æ ‡è®°é˜¶æ®µåˆ†ä¸ºå¤šé˜¶æ®µçš„ï¼š</p><ol><li>ä½¿ç”¨ä¸€ä¸ªæ ˆä¸“é—¨ç”¨æ¥å­˜å‚¨ç°è‰²å¯¹è±¡ï¼Œè¢«ç§°ä¸ºç°è‰²æ ˆ(grayStack)ï¼›</li><li>å¼€å§‹æ ‡è®°æ—¶ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯<strong>ç™½è‰²</strong>çš„ï¼ŒGC roots æ˜¯å¯è¾¾çš„ï¼Œå°† GC roots æ ‡è®°ä¸ºç°è‰²ï¼Œå¹¶å…¥æ ˆï¼›</li><li>ä¾æ¬¡å°†å¯¹è±¡ä»æ ˆé¡¶å‡ºæ ˆï¼Œæ‰¾åˆ°å‡ºæ ˆå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œå°†å¼•ç”¨å¯¹è±¡å…¥æ ˆï¼Œç„¶åå°†å‡ºæ ˆå¯¹è±¡æ ‡è®°ä¸º<strong>é»‘è‰²</strong>ï¼›</li><li>é‡å¤æ­¥éª¤ 3ï¼Œç›´åˆ°æ ˆä¸­å†æ— ç°è‰²å¯¹è±¡ï¼Œåˆ™ä»£è¡¨æ‰€æœ‰å¯è¾¾å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸ºé»‘è‰²ï¼›</li><li>å‰©ä¸‹çš„ç™½è‰²å¯¹è±¡éƒ½æ˜¯åƒåœ¾å¯¹è±¡ï¼Œç­‰å¾…å›æ”¶æ¸…ç†ã€‚</li></ol><p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/assets/tricolor-2cf38e20.png" alt="tricolor"></p><p>è¿™æ ·ç°è‰²å¯¹è±¡ç”±æ ˆæ¥ç®¡ç†ï¼Œä¸€æ¬¡æ€§çš„æ‰«æå°±å¯ä»¥é€šè¿‡æ ˆæ¥åˆ†ä¸ºå¤šæ¬¡ï¼Œå¾…æ ˆä¸ºç©ºæ—¶ï¼Œåˆ™æ‰«æå®Œæ¯•ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬ä¸º VM ç»“æ„ä½“æ·»åŠ ä¸€ä¸ªç°è‰²æ ˆï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> VM <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	numObjects <span class="token builtin">int</span>
	maxObjects <span class="token builtin">int</span>
	link       <span class="token operator">*</span>Object
	stack      <span class="token punctuation">[</span>stackMax<span class="token punctuation">]</span><span class="token operator">*</span>Object
	stackSize  <span class="token builtin">int</span>

	grayStack <span class="token punctuation">[</span>grayMax<span class="token punctuation">]</span><span class="token operator">*</span>Object  <span class="token comment">// ç°è‰²æ ˆ</span>
	grayCount <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>GC å‡½æ•°ä¹Ÿä¼šæœ‰ç›¸åº”çš„æ”¹é€ ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
	<span class="token comment">// mark</span>
	v<span class="token punctuation">.</span><span class="token function">markRoots</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// traceReference è·Ÿè¸ªç°è‰²å¯¹è±¡</span>
	v<span class="token punctuation">.</span><span class="token function">traceReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// sweep</span>
	v<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>GC åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼š</p><ul><li>markRootsï¼šæ ‡è®°æ‰€æœ‰ GC roots å¯¹è±¡ä¸ºé»‘è‰²ï¼Œå°†å…¶å¼•ç”¨å¯¹è±¡å…¥æ ˆï¼›</li><li>traceReferenceï¼šè·Ÿè¸ªæ ˆä¸­çš„ç°è‰²å¯¹è±¡ï¼Œä¾æ¬¡å‡ºæ ˆï¼Œç„¶åå°†å…¶å¼•ç”¨å¯¹è±¡å…¥æ ˆï¼Œæ³¨æ„ï¼šè¿™ä¸€æ­¥æ˜¯å¯ä»¥å¤šæ‰¹æ¬¡è¿›è¡Œçš„ï¼›</li><li>sweepï¼šæ¸…ç†æ‰ä¸å¯è¾¾çš„ç™½è‰²å¯¹è±¡ã€‚</li></ul><p>å®ç°åˆ†åˆ«å¦‚ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">markRoots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token punctuation">.</span>stackSize<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span><span class="token function">markObject</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ç„¶å°†æ ˆ(ä¸æ˜¯ç°è‰²æ ˆ)ä¸­å¯¹è±¡ä½œä¸º GC rootsï¼›</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">traceReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> v<span class="token punctuation">.</span>grayCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">.</span>grayCount <span class="token operator">-=</span> <span class="token number">1</span>
		object <span class="token operator">:=</span> v<span class="token punctuation">.</span>grayStack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>grayCount<span class="token punctuation">]</span>
		<span class="token comment">// å‡ºæ ˆï¼Œç„¶åæœç´¢è¿æ¥å¯¹è±¡</span>
		v<span class="token punctuation">.</span><span class="token function">blacken</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·Ÿè¸ªç°è‰²æ ˆä¸­çš„å¯¹è±¡ï¼Œå°†å…¶å¼•ç”¨å¯¹è±¡å…¥æ ˆï¼Œä¸”é¢œè‰²å˜ä¸ºé»‘è‰²ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">blacken</span><span class="token punctuation">(</span>o <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>typ <span class="token operator">==</span> ObjInt <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>typ <span class="token operator">==</span> ObjPair <span class="token punctuation">{</span>
		p <span class="token operator">:=</span> o<span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Pair<span class="token punctuation">)</span>
		v<span class="token punctuation">.</span><span class="token function">markObject</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>head<span class="token punctuation">)</span> <span class="token comment">// å…¥æ ˆ</span>
		v<span class="token punctuation">.</span><span class="token function">markObject</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>tail<span class="token punctuation">)</span> <span class="token comment">// å…¥æ ˆ</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">markObject</span><span class="token punctuation">(</span>o <span class="token operator">*</span>Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	o<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>grayStack<span class="token punctuation">[</span>v<span class="token punctuation">.</span>grayCount<span class="token punctuation">]</span> <span class="token operator">=</span> o
	v<span class="token punctuation">.</span>grayCount<span class="token operator">++</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œå½“ç°è‰²æ ˆä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ sweep å‡½æ•°æ¸…ç†ç™½è‰²å¯¹è±¡ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VM<span class="token punctuation">)</span> <span class="token function">sweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	obj <span class="token operator">:=</span> v<span class="token punctuation">.</span>link
	<span class="token keyword">for</span> obj <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>obj<span class="token punctuation">.</span>marked <span class="token punctuation">{</span> <span class="token comment">// æœªè¢«æ ‡è®°çš„ï¼Œå°±æ˜¯ç™½è‰²å¯¹è±¡</span>
			unreached <span class="token operator">:=</span> obj
			obj <span class="token operator">=</span> unreached<span class="token punctuation">.</span>next
			addr <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>unreached<span class="token punctuation">)</span><span class="token punctuation">)</span>
			tcmalloc<span class="token punctuation">.</span><span class="token function">Free</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
			v<span class="token punctuation">.</span>numObjects<span class="token operator">--</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			obj<span class="token punctuation">.</span>marked <span class="token operator">=</span> <span class="token boolean">false</span>
			obj <span class="token operator">=</span> obj<span class="token punctuation">.</span>next
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•ç‰ˆçš„ä¸‰è‰²æ ‡è®°ç®—æ³•å°±è¢«å®ç°å‡ºæ¥äº†ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestVM_GC2</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	assert <span class="token operator">:=</span> assert<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	vm <span class="token operator">:=</span> <span class="token function">NewVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>numObjects<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">Free</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œï¼Œvm æ–°å»ºäº†å¯¹è±¡ 1ï¼Œ2ï¼Œä½†éƒ½ä¸æ˜¯ GC rootsï¼Œä¸”ä¸å¯è¾¾ï¼Œå› æ­¤ GC åï¼Œå¯¹è±¡ä¸ªæ•°ä¸º 0ã€‚</p><p>ç°è‰²æ ˆçš„æœºåˆ¶å·§å¦™åœ°å°†ç°è‰²æ ‡è®°åˆ†æˆäº†å¤šé˜¶æ®µï¼Œè€Œä¸”é»‘è‰²ã€ç°è‰²ã€ç™½è‰²å¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é¢œè‰²æ ‡è®°ï¼Œæœªæ ‡è®°çš„å¯¹è±¡è‡ªç„¶æ˜¯ç™½è‰²ï¼Œæ ‡è®°äº†ä¸”åœ¨ç°è‰²æ ˆä¸­çš„å¯¹è±¡æ˜¯ç°è‰²ï¼Œæ ‡è®°äº†ä¸”å‡ºæ ˆçš„å¯¹è±¡æ‰æ˜¯é»‘è‰²å¯¹è±¡ã€‚</p><h2 id="go-å†…å­˜ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#go-å†…å­˜ç®¡ç†" aria-hidden="true">#</a> Go å†…å­˜ç®¡ç†</h2><p>ç»ˆäºé“ºå«åˆ°äº†è¿™é‡Œï¼Œåœ¨å‰é¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«ä»‹ç»æ‰‹åŠ¨å†…å­˜ç®¡ç†ä¸è‡ªåŠ¨å†…å­˜ç®¡ç†çš„åŸç†ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œå®ç°äº†æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„ tcmalloc ä»¥åŠé¼é¼å¤§åçš„ GC ç®—æ³•â€”â€”ä¸‰è‰²æ ‡è®°æ³•ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¯´æ˜¯é“ºå«å‘¢ï¼Ÿå› ä¸º Go çš„å†…å­˜ç®¡ç†çš„ä¸¤å¤§æ ¸å¿ƒæ­£æ˜¯ tcmalloc å’Œ ä¸‰è‰²æ ‡è®° GC ç®—æ³•ã€‚è¿™ä¸ªå±€å¸ƒåˆ°è¿™é‡Œï¼Œæ˜¯ä¸ºäº†è®©è¯»è€…æ›´æ¸…æ™°ã€æ›´ç›´è§‚ã€æ›´æ·±å…¥åœ°äº†è§£ Go æ˜¯å¦‚ä½•ç®¡ç†å†…å­˜çš„ã€‚</p><p>Go çš„å†…å­˜æ¨¡å—å…¶å®éå¸¸å¤æ‚ï¼Œè™½ç„¶å®ƒçš„æ ¸å¿ƒå®ç°æ˜¯ä¸‰è‰²æ ‡è®°æ³•ï¼Œä½†ä¹Ÿå¤§é‡å€Ÿé‰´äº† tcmallocï¼Œå¦‚æœä¸€å¼€å§‹å°±ç›´å…¥ä¸»é¢˜ï¼Œå¾ˆå¤šäººéƒ½ä¼šä¸çŸ¥æ‰€äº‘ï¼Œç¬”è€…æœ€å¼€å§‹å°±æ˜¯è¿™æ ·çš„ï¼Œå› æ­¤ç¬”è€…é“ºå«äº†å¤§é‡çš„å†…å­˜ã€GC çŸ¥è¯†ï¼Œå°±æ˜¯ä¸ºäº†æ­¤åˆ»èƒ½å¤Ÿå°† Go çš„å†…å­˜ç®¡ç†å˜å¾—å®¹æ˜“ç†è§£ä¸€äº›ã€‚</p><p>Go çš„å†…å­˜ç®¡ç†æ˜¯ä¸€ä¸ªçœŸæ­£çš„å·¥ä¸šçº§å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„å°†å…¶åˆ†ä¸ºï¼šç”¨æˆ·ç¨‹åº(Mutator)ã€å†…å­˜åˆ†é…(Allocator)å’Œåƒåœ¾å›æ”¶(Garbage Collector)ä¸‰å¤§æ¨¡å—ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥ä¾æ¬¡çœ‹çœ‹ Go æ˜¯å¦‚ä½•å®ç°è¿™ä¸‰å¤§æ¨¡å—çš„ã€‚</p><ul><li>å†…å­˜åˆ†é…ï¼š</li></ul><p>åœ¨å‰é¢çš„åŸºç¡€ä¸Šï¼Œå®ƒå¼•å…¥äº†å±éšœæŠ€æœ¯ã€ä¸‰è‰²ä¸å˜æ€§æ¥å®ç°å¹¶å‘ã€å¢é‡å¯¹è±¡æ ‡è®°ï¼Œ</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>å†™åˆ°è¿™é‡Œï¼Œç¬”è€…ä¸ç»æ„Ÿå¹ï¼Œè¿™ç¯‡æ–‡ç« å†™çš„å®åœ¨æ˜¯ä¸å®¹æ˜“ï¼</p><p>ç”±äº Go GC æœ¬èº«çš„å¤æ‚æ€§ã€‚</p><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-hidden="true">#</a> å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://github.com/heiyeluren/xmm" target="_blank" rel="noopener noreferrer">xmm<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/authorNari/minigc" target="_blank" rel="noopener noreferrer">minigc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="http://www.craftinginterpreters.com/garbage-collection.html" target="_blank" rel="noopener noreferrer">crafting interpreters<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/" target="_blank" rel="noopener noreferrer">golang-garbage-collector<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/brewlin/garbage-collect" target="_blank" rel="noopener noreferrer">garbage-collect<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/kongwu-/gc_impl" target="_blank" rel="noopener noreferrer">gc impl<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://segmentfault.com/a/1190000022062597" target="_blank" rel="noopener noreferrer">åƒåœ¾å›æ”¶ç®—æ³•å®ç°ä¹‹-æ ‡è®°-æ¸…é™¤<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://medium.com/@ankur_anand/a-visual-guide-to-golang-memory-allocator-from-ground-up-e132258453ed" target="_blank" rel="noopener noreferrer">A visual guide to Go Memory Allocator from scratch (Golang)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://medium.com/swlh/gravity-the-allocator-d443f970123e" target="_blank" rel="noopener noreferrer">Gravityâ€” An MMAP Allocator<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/couchbase/go-slab" target="_blank" rel="noopener noreferrer">go-slab - slab allocator in go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://brunocalza.me/discovering-and-exploring-mmap-using-go/" target="_blank" rel="noopener noreferrer">Discovering and exploring mmap using Go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://people.eecs.berkeley.edu/~kubitron/courses/cs194-24-S13/hand-outs/bonwick_slab.pdf" target="_blank" rel="noopener noreferrer">The Slab Allocator: An Object-Caching Kernel Memory Allocator<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://my.eng.utah.edu/~cs4400/malloc.pdf" target="_blank" rel="noopener noreferrer">malloc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://arjunsreedharan.org/post/148675821737/write-a-simple-memory-allocator" target="_blank" rel="noopener noreferrer">Write a simple memory allocator<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="http://tigerb.cn/2021/01/31/go-base/tcmalloc/" target="_blank" rel="noopener noreferrer">tcmalloc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/" target="_blank" rel="noopener noreferrer">golang-memory-allocator<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://hammertux.github.io/slab-allocator" target="_blank" rel="noopener noreferrer">The Slab Allocator in the Linux kernel<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.dingmos.com/index.php/archives/23/" target="_blank" rel="noopener noreferrer">Linux å†…æ ¸ | å†…å­˜ç®¡ç†â€”â€”Slab åˆ†é…å™¨<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://zhuanlan.zhihu.com/p/152119007" target="_blank" rel="noopener noreferrer">20 å¼ å›¾æ­å¼€ã€Œå†…å­˜ç®¡ç†ã€çš„è¿·é›¾ï¼Œç¬é—´è±ç„¶å¼€æœ—<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html" target="_blank" rel="noopener noreferrer">è®¤çœŸåˆ†æ mmap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/MQN-80/MQN-80.github.io/edit/main/posts/go/mem.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 3218290253@qq.com">MQN-80</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a aria-label="go å¦å¤–å‡ ä¸ªé»‘é­”æ³•æŠ€å·§" class="vp-link nav-link prev nav-link prev" href="/posts/go/magic2.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><span class="font-icon icon iconfont icon-edit" style=""></span>go å¦å¤–å‡ ä¸ªé»‘é­”æ³•æŠ€å·§</div></a><!----></nav><div id="comment" class="giscus-wrapper" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">keep running</div><div class="vp-copyright">Copyright Â© 2024 MQN-80</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-7dd07e0d.js" defer></script>
  </body>
</html>
